<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;,">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token ‰ø°ÊÅØÁÆ°ÁêÜ</title>
  <!-- ÂºïÂÖ•ÂÖ±‰∫´Ê†∑Âºè -->
  <link rel="stylesheet" href="/static/shared-styles.css">
  <script src="/static/shared.js"></script>
  <style>
    /* Êñá‰ª∂Á≥ªÁªüÂ∏ÉÂ±ÄÊ†∑Âºè */
    .file-system {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
      overflow: hidden;
      height: calc(100vh - 250px);
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
      background: var(--card-background);
    }

    .toolbar .search-box {
      flex: 1;
      margin-right: 8px;
      position: relative;
    }

    .toolbar .search-box input {
      width: 100%;
      padding-left: 32px;
    }

    .toolbar .search-box::before {
      content: "üîç";
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .toolbar .view-toggles button {
      height: 36px;
      min-width: 36px;
    }

    .token-files {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      user-select: none;
      padding: 0 12px 12px 12px;
    }

    .file-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
    }

    .file-list th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--card-background);
      padding: 10px;
      text-align: left;
      font-weight: 500;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .file-list th:hover {
      background: var(--disabled-bg);
    }

    .file-list td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .file-list tr {
      cursor: pointer;
    }

    .file-list tr:hover {
      background: var(--primary-color-alpha);
    }

    .file-list tr.selected {
      background: var(--primary-color-alpha);
    }

    .file-list tr.focused {
      background: var(--primary-color);
      color: white;
    }

    .file-list tr.focused td {
      color: white;
    }

    .file-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 8px;
      vertical-align: middle;
    }

    .status-bar {
      padding: 8px;
      background: var(--card-background);
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }

    /* Âè≥ÈîÆËèúÂçï */
    .context-menu {
      position: fixed;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 4px 0;
      z-index: 1000;
      min-width: 180px;
      display: none;
    }

    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      position: relative;
    }

    .context-menu-item:hover {
      background: var(--primary-color-alpha);
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border-color);
      margin: 4px 0;
    }

    .context-menu-shortcut {
      margin-left: auto;
      color: var(--text-secondary);
      font-size: 12px;
    }

    /* ÈÄâÊã©Ê°Ü */
    .selection-box {
      position: absolute;
      border: 1px dashed var(--primary-color);
      background: rgba(33, 150, 243, 0.1);
      z-index: 5;
      pointer-events: none;
    }

    /* ËØ¶ÊÉÖÈù¢Êùø */
    .details-panel {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      width: 500px;
      background: var(--card-background);
      border-left: 1px solid var(--border-color);
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      padding: 16px;
      overflow-y: auto;
      z-index: 100;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .details-panel.open {
      transform: translateX(0);
    }

    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .details-header h3 {
      margin: 0;
    }

    .details-header button {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: var(--text-secondary);
    }

    .details-content {
      margin-bottom: 16px;
    }

    .details-property {
      margin-bottom: 12px;
    }

    .details-property-name {
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .details-property-value {
      color: var(--text-primary);
      word-break: break-all;
    }

    .details-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .details-actions button {
      flex: 1;
      min-width: 120px;
    }

    /* ÂºπÂá∫ÂØπËØùÊ°ÜÊ†∑Âºè */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-background);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 90%;
      max-width: 500px;
      color: var(--text-primary);
      height: 80vh;
      overflow-y: auto;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .modal-header {
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }

    .modal-body {
      margin-bottom: 15px;
    }

    .modal-footer {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
      text-align: right;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Á≠õÈÄâÈù¢Êùø */
    .filter-panel {
      padding: 16px;
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
    }

    .filter-row {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 220px;
      position: relative;
    }

    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .filter-group select {
      width: 100%;
      min-height: 38px;
    }

    .filter-input-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .filter-input-group input {
      flex: 1;
      min-width: 0;
      min-height: 38px;
    }

    .filter-input-group span {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .filter-actions {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }

    .filter-actions-left {
      flex: 1;
      min-width: 220px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-actions-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 40px;
    }

    /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
    @media (max-width: 1200px) {
      .filter-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-actions-left {
        margin-bottom: 12px;
      }

      .filter-actions-right {
        justify-content: flex-end;
      }
    }

    @media (max-width: 768px) {
      .filter-actions-right {
        justify-content: flex-start;
      }

      .button-group button {
        flex: 1;
        min-width: 0;
      }

      #detailsPanel {
        width: 100%;
      }
    }

    /* ÊâòÁõòÊ∂àÊÅØ */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
      max-width: 350px;
      max-height: 80vh;
      overflow-y: hidden;
      padding-top: 10px;
      padding-bottom: 10px;
      padding-right: 5px;
    }

    .toast {
      background: var(--card-background);
      color: var(--text-primary);
      padding: 10px 16px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      min-width: 200px;
      margin-left: auto;
      will-change: transform, opacity;
      pointer-events: auto;
    }

    .toast.info {
      border-left: 4px solid #2196F3;
    }

    .toast.error {
      background: #f44336;
      color: white;
    }

    .toast.success {
      background: #4caf50;
      color: white;
    }

    .toast.warning {
      background: #ff9800;
      color: white;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Â§ÑÁêÜÁ∫µÂêëÊªöÂä® */
    @media (max-height: 600px) {
      .file-system {
        height: 400px;
      }
    }

    .key-result {
      background: var(--card-background);
      padding: var(--spacing);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      margin-top: var(--spacing);
      position: relative;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .key-result:hover {
      background: var(--primary-color-alpha);
      border-color: var(--primary-color);
    }

    .key-result:active {
      transform: translateY(1px);
    }

    .key-content {
      overflow-x: auto;
      white-space: nowrap;
      scrollbar-width: thin;
      -ms-overflow-style: none;
    }

    /* ÊâπÈáèÊìç‰ΩúÂå∫Âüü */
    .batch-operations {
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: var(--spacing);
      padding: var(--spacing);
      display: none;
    }

    .batch-operations .form-group {
      margin-bottom: 12px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: flex-end;
      margin: 0;
    }

    .button-group button {
      height: 38px;
      min-width: 100px;
      white-space: nowrap;
    }

    .button-group button .context-menu-shortcut {
      margin-left: 5px;
      opacity: 0.7;
      font-size: 12px;
    }

    /* ‰ª£ÁêÜÂ≠êËèúÂçïÊ†∑Âºè */
    .proxy-menu {
      position: relative;
    }

    .proxy-submenu {
      position: absolute;
      left: 100%;
      top: 0;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 4px 0;
      min-width: 180px;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }

    .proxy-menu:hover>.proxy-submenu {
      opacity: 1;
      visibility: visible;
    }

    .context-menu-item.has-submenu::after {
      content: "‚Ä∫";
      position: absolute;
      right: 8px;
      font-size: 18px;
    }

    .check-mark {
      margin-left: auto;
      visibility: hidden;
    }

    .check-mark::after {
      content: "‚úì";
    }

    .context-menu-item.active .check-mark {
      visibility: visible;
    }

    .context-menu-item.active span:first-child {
      font-weight: bold;
    }

    .proxy-count {
      color: var(--text-secondary);
      font-size: 12px;
      margin-left: 8px;
    }

    /* Âêë‰∏äÂ±ïÂºÄÁöÑÂ≠êËèúÂçïÊ†∑Âºè */
    .proxy-menu.open-upward .proxy-submenu {
      top: auto;
      bottom: 0;
    }

    /* ÂêëÂ∑¶Â±ïÂºÄÁöÑÂ≠êËèúÂçïÊ†∑Âºè */
    .proxy-menu.open-leftward .proxy-submenu {
      right: 100%;
      left: auto;
    }

    /* Êó∂Âå∫ÂêçÁß∞Âíå‰ª£ÁêÜÂêçÁß∞ÂÖ±‰∫´Ê†∑Âºè */
    .timezone-name,
    .proxy-name {
      cursor: pointer;
      padding: 3px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      border: 1px solid transparent;
      background-color: var(--disabled-bg);
      font-size: 0.9em;
      position: relative;
    }

    .timezone-name:hover,
    .proxy-name:hover {
      background-color: var(--primary-color-alpha);
      color: var(--primary-color);
      border-color: var(--primary-color);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .timezone-name:active,
    .proxy-name:active {
      transform: translateY(0px);
      box-shadow: none;
    }

    .timezone-name:hover::after,
    .proxy-name:hover::after {
      opacity: 1;
    }

    /* Áä∂ÊÄÅÊåáÁ§∫Ê†áÊ†∑Âºè */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-enabled {
      background-color: #4CAF50;
      /* ÁªøËâ≤ */
    }

    .status-disabled {
      background-color: #F44336;
      /* Á∫¢Ëâ≤ */
    }

    .status-other {
      background-color: #FFC107;
      /* ÈªÑËâ≤ */
    }

    /* Áä∂ÊÄÅÂ≠êËèúÂçïÊ†∑Âºè */
    .status-menu {
      position: relative;
    }

    .status-submenu {
      position: absolute;
      left: 100%;
      top: 0;
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 4px 0;
      min-width: 150px;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }

    .status-menu:hover .status-submenu {
      opacity: 1;
      visibility: visible;
    }

    /* Ê∑ªÂä†Âêë‰∏äÂíåÂêëÂ∑¶ÊâìÂºÄÁöÑÊ†∑Âºè */
    .status-menu.open-upward .status-submenu {
      top: auto;
      bottom: 0;
    }

    .status-menu.open-leftward .status-submenu {
      left: auto;
      right: 100%;
    }

    /* Ê∑ªÂä†Áä∂ÊÄÅËÆ°Êï∞Ê†∑Âºè */
    .status-count {
      color: var(--text-secondary);
      font-size: 12px;
      margin-left: 8px;
    }
  </style>
</head>

<body>
  <h1>Token ‰ø°ÊÅØÁÆ°ÁêÜ</h1>

  <div class="container">
    <div class="form-group">
      <label>ËÆ§ËØÅ‰ª§Áâå:</label>
      <input type="password" id="authToken" placeholder="ËæìÂÖ• AUTH_TOKEN">
    </div>
  </div>

  <!-- Á≠õÈÄâÈù¢Êùø -->
  <div class="filter-panel">
    <div class="filter-row">
      <div class="filter-group">
        <label>Ë¥¶Êà∑Á±ªÂûã:</label>
        <select id="membershipFilter">
          <option value="all">ÂÖ®ÈÉ®Á±ªÂûã</option>
          <option value="free">ÂÖçË¥πÁâà</option>
          <option value="free_trial">ËØïÁî®Áâà</option>
          <option value="pro">‰∏ì‰∏öÁâà</option>
          <option value="enterprise">‰ºÅ‰∏öÁâà</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Êó∂Âå∫Á≠õÈÄâ:</label>
        <select id="timezoneFilter">
          <option value="all">ÂÖ®ÈÉ®Êó∂Âå∫</option>
          <option value="none">Êú™ÊåáÂÆöÊó∂Âå∫</option>
          <!-- Êó∂Âå∫ÂàóË°®Â∞ÜÂú®JavaScript‰∏≠Âä®ÊÄÅÂ°´ÂÖÖ -->
        </select>
      </div>
      <div class="filter-group">
        <label>Áî®ÈáèÁä∂ÊÄÅ:</label>
        <div class="filter-input-group">
          <input type="number" id="usageMin" placeholder="ÊúÄÂ∞èÂÄº">
          <span>Ëá≥</span>
          <input type="number" id="usageMax" placeholder="ÊúÄÂ§ßÂÄº">
        </div>
      </div>
      <div class="filter-group">
        <label>ËØïÁî®Ââ©‰Ωô:</label>
        <div class="filter-input-group">
          <input type="number" id="trialMin" placeholder="ÊúÄÂ∞èÂ§©Êï∞">
          <span>Ëá≥</span>
          <input type="number" id="trialMax" placeholder="ÊúÄÂ§ßÂ§©Êï∞">
        </div>
      </div>
    </div>

    <div class="filter-actions">
      <div class="filter-actions-left">
        <div class="filter-group">
          <label>ProfileÁä∂ÊÄÅ:</label>
          <select id="profileFilter">
            <option value="all">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
            <option value="has_profile">ÊúâProfile</option>
            <option value="no_profile">Êó†Profile</option>
          </select>
        </div>
        <div class="filter-group">
          <label>‰ª£ÁêÜÁ≠õÈÄâ:</label>
          <select id="proxyFilter">
            <option value="all">ÂÖ®ÈÉ®‰ª£ÁêÜ</option>
            <option value="none">Êú™ÊåáÂÆö‰ª£ÁêÜ</option>
            <!-- ‰ª£ÁêÜÂàóË°®Â∞ÜÂú®JavaScript‰∏≠Âä®ÊÄÅÂ°´ÂÖÖ -->
          </select>
        </div>
      </div>
      <div class="filter-actions-right">
        <button id="refreshBtn" onclick="getTokenInfo()" class="primary">
          <span>Âà∑Êñ∞ÂàóË°®</span>
          <span class="context-menu-shortcut">F5</span>
        </button>
        <button id="addTokenBtn" onclick="addTokens()" class="secondary">Ê∑ªÂä†Token</button>
        <button id="exportBtn" onclick="exportTokens()" class="secondary">ÂØºÂá∫ÂàóË°®</button>
        <button id="importBtn" onclick="importTokens()" class="secondary">ÂØºÂÖ•ÂàóË°®</button>
      </div>
    </div>
  </div>

  <!-- Êñá‰ª∂Á≥ªÁªüÂå∫Âüü -->
  <div class="file-system">
    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢TokenÊàñË¥¶Êà∑...">
      </div>
    </div>

    <div class="token-files">
      <table class="file-list">
        <thead>
          <tr>
            <th>Ë¥¶Êà∑/Token</th>
            <th style="width: 15%;">‰ºöÂëòÁ±ªÂûã</th>
            <th style="width: 15%;">Áî®Èáè</th>
            <th style="width: 10%;">ËØïÁî®Ââ©‰Ωô</th>
            <th style="width: 10%;">Êó∂Âå∫</th>
            <th style="width: 10%;">‰ª£ÁêÜ</th>
          </tr>
        </thead>
        <tbody id="fileListBody">
          <!-- Âä®ÊÄÅÁîüÊàêÁöÑÊñá‰ª∂ÂàóË°® -->
        </tbody>
      </table>
      <div id="emptyState" style="display: none; padding: 40px; text-align: center; color: var(--text-secondary);">
        <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
        <h3>Ê≤°ÊúâÊâæÂà∞Token</h3>
        <p>ËØ∑Ê∑ªÂä†TokenÊàñÊõ¥ÊîπÁ≠õÈÄâÊù°‰ª∂</p>
        <button onclick="addTokens()" class="primary">Ê∑ªÂä†Token</button>
      </div>
      <!-- ÈÄâÊã©Ê°Ü -->
      <div id="selectionBox" class="selection-box"></div>
    </div>

    <div class="status-bar">
      <div id="selectionStatus">Â∑≤ÈÄâÊã©: 0 ‰∏™È°πÁõÆ</div>
      <div id="totalCount">ÂÖ± 0 ‰∏™Token</div>
    </div>
  </div>

  <!-- Âè≥ÈîÆËèúÂçï -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item status-menu">
      <span>ÂàáÊç¢Áä∂ÊÄÅ</span>
      <div class="status-submenu" id="statusSubmenu">
        <div class="context-menu-item" onclick="setTokenStatus('enabled')">
          <span>ÂêØÁî®</span>
          <span class="status-count">0</span>
          <span class="check-mark"></span>
        </div>
        <div class="context-menu-item" onclick="setTokenStatus('disabled')">
          <span>Á¶ÅÁî®</span>
          <span class="status-count">0</span>
          <span class="check-mark"></span>
        </div>
      </div>
    </div>
    <div class="context-menu-item" onclick="viewDetails()">
      <span>Êü•ÁúãËØ¶ÊÉÖ</span>
      <span class="context-menu-shortcut">Enter</span>
    </div>
    <div class="context-menu-item" onclick="refreshSelectedProfiles()">
      <span>Âà∑Êñ∞Profile</span>
      <span class="context-menu-shortcut">F5</span>
    </div>
    <div class="context-menu-item" onclick="upgradeSelectedTokens()">
      <span>ÂçáÁ∫ßToken</span>
      <span class="context-menu-shortcut">Ctrl+U</span>
    </div>
    <div class="context-menu-item" onclick="generateKey()">
      <span>ÁîüÊàêKey</span>
      <span class="context-menu-shortcut">Ctrl+G</span>
    </div>
    <div class="context-menu-item" onclick="copyTokenToClipboard()">
      <span>Â§çÂà∂Token</span>
      <span class="context-menu-shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-item" onclick="openTimezoneSelector()">
      <span>ËÆæÁΩÆÊó∂Âå∫</span>
    </div>
    <div class="context-menu-item proxy-menu">
      <span>ËÆæÁΩÆ‰ª£ÁêÜ</span>
      <div class="proxy-submenu" id="proxySubmenu">
        <div class="context-menu-item" onclick="setProxy('')">
          <span>Êú™ÊåáÂÆö</span>
          <span class="proxy-count">0</span>
          <span class="check-mark"></span>
        </div>
        <div class="context-menu-divider"></div>
        <!-- ‰ª£ÁêÜÂàóË°®Â∞ÜÂä®ÊÄÅÊ∑ªÂä†Âú®ËøôÈáå -->
      </div>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="deleteSelectedTokens()">
      <span>Âà†Èô§</span>
      <span class="context-menu-shortcut">Delete</span>
    </div>
  </div>

  <!-- ËØ¶ÊÉÖÈù¢Êùø -->
  <div id="detailsPanel" class="details-panel">
    <div class="details-header">
      <h3 id="detailsTitle">TokenËØ¶ÊÉÖ</h3>
      <button onclick="toggleDetailsPanel(false)" style="width: unset;">√ó</button>
    </div>
    <div id="detailsContent" class="details-content">
      <!-- ËØ¶ÊÉÖÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
    </div>
    <div class="details-actions">
      <button onclick="refreshSelectedProfiles()" class="secondary">Âà∑Êñ∞Profile</button>
      <button onclick="generateKey()" class="secondary">ÁîüÊàêKey</button>
      <button onclick="deleteSelectedTokens()" class="danger">Âà†Èô§</button>
    </div>
  </div>

  <!-- ÁîüÊàêKeyÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="keyModal-backdrop"></div>
  <div class="modal" id="keyModal">
    <div class="modal-header">
      <h3>ÁîüÊàêÂä®ÊÄÅKey</h3>
      <button class="modal-close" onclick="closeModal('keyModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Token:</label>
        <div id="keyToken"
          style="word-break: break-all; background: var(--disabled-bg); padding: 8px; border-radius: var(--border-radius); margin-bottom: 10px;">
        </div>
      </div>
      <div class="form-group">
        <label>ÂõæÁâáÂ§ÑÁêÜËÉΩÂäõ:</label>
        <select id="disableVision">
          <option value="">Ë∑üÈöèÂÖ®Â±Ä</option>
          <option value="true">Á¶ÅÁî®</option>
          <option value="false">ÂêØÁî®</option>
        </select>
      </div>
      <div class="form-group">
        <label>ÊÖ¢ÈÄüÊ±†:</label>
        <select id="enableSlowPool">
          <option value="">Ë∑üÈöèÂÖ®Â±Ä</option>
          <option value="true">ÂêØÁî®</option>
          <option value="false">Á¶ÅÁî®</option>
        </select>
      </div>
      <div class="form-group">
        <label>‰ΩøÁî®ÈáèÊ£ÄÊü•Ê®°ÂûãËßÑÂàô:</label>
        <select id="usageCheckType" onchange="toggleModelList()">
          <option value="">Ë∑üÈöèÂÖ®Â±Ä</option>
          <option value="default">ÈªòËÆ§</option>
          <option value="disabled">Á¶ÅÁî®</option>
          <option value="all">ÊâÄÊúâ</option>
          <option value="custom">Ëá™ÂÆö‰πâ</option>
        </select>
        <div id="modelListContainer" class="model-list"
          style="display: none; max-height: 150px; overflow-y: auto; margin-top: 8px;">
          <!-- Âä®ÊÄÅÂ°´ÂÖÖÊ®°ÂûãÂàóË°® -->
        </div>
      </div>
      <div class="form-group">
        <label>‰ª£ÁêÜÊúçÂä°Âô®:</label>
        <select id="proxySelect">
          <option value="">Ë∑üÈöèTokenËÆæÁΩÆ</option>
          <!-- ‰ª£ÁêÜÈÄâÈ°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </select>
      </div>
      <div class="form-group">
        <label>ÂåÖÂê´ÁΩëÁªúÂºïÁî®:</label>
        <select id="includeWebReferences">
          <option value="">Ë∑üÈöèÂÖ®Â±Ä</option>
          <option value="true">ÂêØÁî®</option>
          <option value="false">Á¶ÅÁî®</option>
        </select>
      </div>
      <div class="key-result" id="keyResult" style="display: none;" onclick="copyGeneratedKey()">
        <div class="key-content" id="keyContent"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('keyModal')" class="secondary">ÂèñÊ∂à</button>
      <button onclick="generateKeySubmit()" class="primary">ÁîüÊàê</button>
    </div>
  </div>

  <!-- Á°ÆËÆ§Âà†Èô§ÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="confirmModal-backdrop"></div>
  <div class="modal" id="confirmModal">
    <div class="modal-header">
      <h3>Á°ÆËÆ§Âà†Èô§</h3>
      <button class="modal-close" onclick="closeModal('confirmModal')">√ó</button>
    </div>
    <div class="modal-body">
      <p id="confirmMessage">Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑTokenÂêóÔºü</p>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('confirmModal')" class="secondary">ÂèñÊ∂à</button>
      <button onclick="confirmDeleteTokens()" class="danger">Âà†Èô§</button>
    </div>
  </div>

  <!-- ÊâπÈáèÊ∑ªÂä†ÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="addTokensModal-backdrop"></div>
  <div class="modal" id="addTokensModal">
    <div class="modal-header">
      <h3>ÊâπÈáèÊ∑ªÂä†Token</h3>
      <button class="modal-close" onclick="closeModal('addTokensModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Ê∑ªÂä†Token:</label>
        <textarea id="addTokensInput" placeholder="ÊØèË°åËæìÂÖ•‰∏Ä‰∏™tokenÔºåÊ†ºÂºè‰∏∫tokenÊàñtoken,checksum" rows="8"></textarea>
      </div>
      <div class="form-group">
        <label>TokenÁä∂ÊÄÅ:</label>
        <select id="addTokensStatus">
          <option value="enabled">ÂêØÁî®</option>
          <option value="disabled">Á¶ÅÁî®</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('addTokensModal')" class="secondary">ÂèñÊ∂à</button>
      <button onclick="confirmAddTokens()" class="primary">Ê∑ªÂä†</button>
    </div>
  </div>

  <!-- ÂØºÂÖ•ÂØºÂá∫ÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="importModal-backdrop"></div>
  <div class="modal" id="importModal">
    <div class="modal-header">
      <h3>ÂØºÂÖ•TokenÂàóË°®</h3>
      <button class="modal-close" onclick="closeModal('importModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>ÈÄâÊã©JSONÊñá‰ª∂:</label>
        <input type="file" id="importFile" accept=".json">
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('importModal')" class="secondary">ÂèñÊ∂à</button>
      <button onclick="confirmImport()" class="primary">ÂØºÂÖ•</button>
    </div>
  </div>

  <!-- ‰ª£ÁêÜÈÄâÊã©ÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="proxySelectModal-backdrop"></div>
  <div class="modal" id="proxySelectModal">
    <div class="modal-header">
      <h3>ÈÄâÊã©‰ª£ÁêÜ</h3>
      <button class="modal-close" onclick="closeModal('proxySelectModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Ë¥¶Êà∑/Token:</label>
        <div id="currentTokenDisplay"
          style="word-break: break-all; background: var(--disabled-bg); padding: 8px; border-radius: var(--border-radius); margin-bottom: 10px;">
        </div>
      </div>
      <div class="form-group">
        <label>‰ª£ÁêÜÂàóË°®:</label>
        <select id="proxySelectDropdown" style="width: 100%">
          <option value="">Êú™ÊåáÂÆö</option>
          <!-- ‰ª£ÁêÜÂàóË°®Â∞ÜÂä®ÊÄÅÊ∑ªÂä† -->
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('proxySelectModal')" class="secondary">ÂèñÊ∂à</button>
      <button onclick="saveProxySelection()" class="primary">‰øùÂ≠ò</button>
    </div>
  </div>

  <!-- ÂÖ®Â±ÄÈÄöÁü•Âå∫Âüü -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Ê∑ªÂä†Êó∂Âå∫ÈÄâÊã©Ê®°ÊÄÅÊ°Ü -->
  <!-- Êó∂Âå∫ÈÄâÊã©ÂØπËØùÊ°Ü -->
  <div class="modal-backdrop" id="timezoneModal-backdrop"></div>
  <div class="modal" id="timezoneModal">
    <div class="modal-header">
      <h3>ËÆæÁΩÆÊó∂Âå∫</h3>
      <button class="modal-close" onclick="closeModal('timezoneModal')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Ë¥¶Êà∑/Token:</label>
        <div id="timezoneTokenDisplay"
          style="word-break: break-all; background: var(--disabled-bg); padding: 8px; border-radius: var(--border-radius); margin-bottom: 10px;">
        </div>
      </div>
      <div class="form-group">
        <label>ÊêúÁ¥¢Êó∂Âå∫:</label>
        <input type="text" id="timezoneSearchInput" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢Êó∂Âå∫..." style="width: 100%">
      </div>
      <div class="form-group">
        <label>Êó∂Âå∫ÂàóË°®:</label>
        <div id="timezoneListContainer"
          style="max-height: 300px; overflow-y: auto; margin-top: 8px; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
          <!-- Êó∂Âå∫ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeModal('timezoneModal')" class="secondary">ÂèñÊ∂à</button>
      <button onclick="saveTimezoneSelection()" class="primary">‰øùÂ≠ò</button>
    </div>
  </div>

  <script>
    // ÂÖ®Â±ÄÂèòÈáè
    let allTokens = [];
    let globalTags = [];
    let selectedTag = 'all';
    let currentToken = '';
    let currentChecksum = '';
    let tokenToDelete = null;
    let tokenToEditTags = null;
    let availableModels = [];
    let selectedTokens = new Set(); // Â≠òÂÇ®ÈÄâ‰∏≠ÁöÑToken
    let lastSelectedIndex = -1;
    let isMouseDown = false;
    let startPoint = { x: 0, y: 0 };
    let selectionBox = document.getElementById('selectionBox');
    let detailsPanelOpen = false;
    let tokensToDelete = [];
    // ‰ª£ÁêÜÁõ∏ÂÖ≥ÂÖ®Â±ÄÂèòÈáè
    let proxyList = []; // ÁºìÂ≠ò‰ª£ÁêÜÂàóË°®
    let currentProxy = ''; // ÂΩìÂâç‰ΩøÁî®ÁöÑÈÄöÁî®‰ª£ÁêÜ
    // ÂΩìÂâçÊ≠£Âú®ÁºñËæë‰ª£ÁêÜÁöÑtoken
    let currentEditingToken = '';

    // ÂàùÂßãÂåñTokenHandling
    initializeTokenHandling('authToken');

    // Ê£ÄÊµãÊòØMacËøòÊòØÂÖ∂‰ªñÁ≥ªÁªüÔºåMac‰ΩøÁî®metaKey(CommandÈîÆ)ÔºåÂÖ∂‰ªñÁ≥ªÁªü‰ΩøÁî®ctrlKey
    function isModifierKey(e) {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      return isMac ? e.metaKey : e.ctrlKey;
    }

    // ÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', async () => {
      // Ëé∑ÂèñÊ®°ÂûãÂíåToken‰ø°ÊÅØ
      getModels();
      // Ëé∑Âèñ‰ª£ÁêÜÂàóË°®
      await getProxies();
      getTokenInfo();

      // ÁõëÂê¨ÊêúÁ¥¢ËæìÂÖ•
      document.getElementById('searchInput').addEventListener('input', filterTokens);

      // ÁõëÂê¨Á≠õÈÄâ‰∏ãÊãâÊ°Ü
      document.getElementById('membershipFilter').addEventListener('change', filterTokens);
      document.getElementById('usageMin').addEventListener('change', filterTokens);
      document.getElementById('usageMax').addEventListener('change', filterTokens);
      document.getElementById('trialMin').addEventListener('change', filterTokens);
      document.getElementById('trialMax').addEventListener('change', filterTokens);
      document.getElementById('profileFilter').addEventListener('change', filterTokens);
      document.getElementById('proxyFilter').addEventListener('change', filterTokens);
      document.getElementById('timezoneFilter').addEventListener('change', filterTokens); // Êó∂Âå∫Á≠õÈÄâÁõëÂê¨

      // ËÆæÁΩÆÈîÆÁõòÂø´Êç∑ÈîÆ
      setupKeyboardShortcuts();

      // ËÆæÁΩÆÈº†Ê†áÈÄâÊã©
      setupMouseSelection();

      // ËÆæÁΩÆÊñá‰ª∂Á≥ªÁªüÁöÑ‰∏ä‰∏ãÊñáËèúÂçï
      setupContextMenu();

      updateStatusBar();

      // Âø´Êç∑ÈîÆÊîØÊåÅ
      document.addEventListener('keydown', function (e) {
        const modifierKey = isModifierKey(e);
        if (modifierKey && e.key === 'Enter') {
          e.preventDefault();
          const activeElement = document.activeElement;
          if (activeElement.id === 'tokenInput' || activeElement.id === 'batchTokenInput') {
            // Ê†πÊçÆÂΩìÂâçÁÑ¶ÁÇπÁ°ÆÂÆöÊìç‰Ωú
            const action = document.querySelector('.button-group button.active') ||
              document.querySelector('.batch-actions button');
            if (action) {
              action.click();
            }
          }
        } else if (modifierKey && e.key === 'a') {
          if (document.activeElement.tagName !== 'INPUT' &&
            document.activeElement.tagName !== 'TEXTAREA') {
            e.preventDefault();
            selectAllTokens();
          }
        }
      });
    });

    // ËÆæÁΩÆÈîÆÁõòÂø´Êç∑ÈîÆ
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function (e) {
        const modifierKey = isModifierKey(e);

        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          // ‰ΩÜÂÖÅËÆ∏Ctrl/Command+EnterÊâßË°åÊèê‰∫§Êìç‰Ωú
          if (modifierKey && e.key === 'Enter' && e.target.id === 'tokenInput') {
            addTokens();
          }
          return;
        }

        // Êñá‰ª∂Á≥ªÁªüÊìç‰ΩúÂø´Êç∑ÈîÆ
        switch (e.key) {
          case 'a':
            if (modifierKey) {
              e.preventDefault();
              selectAllTokens();
            }
            break;
          case 'c':
            if (modifierKey) {
              e.preventDefault();
              copyTokenToClipboard();
            }
            break;
          case 'Delete':
            e.preventDefault();
            deleteSelectedTokens();
            break;
          case 'Enter':
            e.preventDefault();
            viewDetails();
            break;
          case 'F5':
            e.preventDefault();
            if (selectedTokens.size > 0) {
              refreshSelectedProfiles();
            } else {
              getTokenInfo();
            }
            break;
          case 'u':
            if (modifierKey) {
              e.preventDefault();
              upgradeSelectedTokens();
            }
            break;
          case 'g':
            if (modifierKey) {
              e.preventDefault();
              generateKey();
            }
            break;
          case 'f':
            if (modifierKey) {
              e.preventDefault();
              document.getElementById('searchInput').focus();
            }
            break;
          case 'Escape':
            closeAllModals();
            if (detailsPanelOpen) {
              toggleDetailsPanel(false);
            }
            break;
        }
      });
    }

    // ËÆæÁΩÆÈº†Ê†áÈÄâÊã©
    function setupMouseSelection() {
      const tokenFiles = document.querySelector('.token-files');

      // Èº†Ê†áÊåâ‰∏ãÂºÄÂßãÈÄâÊã©
      tokenFiles.addEventListener('mousedown', function (e) {
        // ‰ªÖÂú®Â∑¶ÈîÆÁÇπÂáª‰∏î‰∏çÊòØÁÇπÂáªÂú®Ë°®Ê†ºË°å‰∏äÊó∂ÂêØÁî®Ê°ÜÈÄâ
        if (e.button !== 0 || e.target.closest('tr') || e.target.closest('button')) {
          return;
        }

        isMouseDown = true;

        const rect = tokenFiles.getBoundingClientRect();
        startPoint = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };

        selectionBox.style.left = startPoint.x + 'px';
        selectionBox.style.top = startPoint.y + 'px';
        selectionBox.style.width = '0px';
        selectionBox.style.height = '0px';
        selectionBox.style.display = 'block';

        // Ê∏ÖÈô§Áé∞ÊúâÈÄâÊã©ÔºåÈô§ÈùûÊåâ‰ΩèCtrlÈîÆ
        if (!isModifierKey(e)) {
          clearSelection();
        }

        e.preventDefault();
      });

      // Èº†Ê†áÁßªÂä®Êõ¥Êñ∞ÈÄâÊã©Ê°Ü
      document.addEventListener('mousemove', function (e) {
        if (!isMouseDown) return;

        const rect = tokenFiles.getBoundingClientRect();
        const currentPoint = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };

        const width = Math.abs(currentPoint.x - startPoint.x);
        const height = Math.abs(currentPoint.y - startPoint.y);

        const left = Math.min(currentPoint.x, startPoint.x);
        const top = Math.min(currentPoint.y, startPoint.y);

        selectionBox.style.left = left + 'px';
        selectionBox.style.top = top + 'px';
        selectionBox.style.width = width + 'px';
        selectionBox.style.height = height + 'px';

        // Ê£ÄÊµã‰∏éË°åÁöÑÁõ∏‰∫§Âπ∂Êõ¥Êñ∞ÈÄâÊã©
        const boxRect = selectionBox.getBoundingClientRect();
        const rows = document.querySelectorAll('#fileListBody tr');

        rows.forEach(row => {
          const rowRect = row.getBoundingClientRect();
          const token = row.dataset.token;

          // Ê£ÄÊü•ÊòØÂê¶Áõ∏‰∫§
          if (
            rowRect.top < boxRect.bottom &&
            rowRect.bottom > boxRect.top &&
            rowRect.left < boxRect.right &&
            rowRect.right > boxRect.left
          ) {
            selectToken(token, true);
          } else if (!isModifierKey(e)) {
            deselectToken(token);
          }
        });

        updateSelectionStatus();
      });

      // Èº†Ê†áÈáäÊîæÁªìÊùüÈÄâÊã©
      document.addEventListener('mouseup', function () {
        if (isMouseDown) {
          isMouseDown = false;
          selectionBox.style.display = 'none';
          updateSelectionStatus();
        }
      });

      // Èò≤Ê≠¢ÊãñÂä®ÈÄâÊã©Êó∂ÈÄâ‰∏≠ÊñáÊú¨
      tokenFiles.addEventListener('selectstart', function (e) {
        if (isMouseDown) {
          e.preventDefault();
        }
      });
    }

    // ËÆæÁΩÆ‰∏ä‰∏ãÊñáËèúÂçï
    function setupContextMenu() {
      const tokenFiles = document.querySelector('.token-files');
      const contextMenu = document.getElementById('contextMenu');

      // Âè≥ÈîÆÁÇπÂáªÊòæÁ§∫ËèúÂçï
      tokenFiles.addEventListener('contextmenu', function (e) {
        const row = e.target.closest('tr');
        if (!row) return;

        e.preventDefault();

        const token = row.dataset.token;

        // Â¶ÇÊûúÁÇπÂáªÁöÑË°å‰∏çÂú®ÈÄâ‰∏≠È°π‰∏≠ÔºåÂàôÊ∏ÖÈô§ÈÄâÊã©Âπ∂ÈÄâ‰∏≠ËØ•Ë°å
        if (!selectedTokens.has(token)) {
          clearSelection();
          selectToken(token);
          updateSelectionStatus();
        }

        // ËÆæÁΩÆÂΩìÂâçÂ§ÑÁêÜÁöÑtoken
        currentToken = token;

        // Êõ¥Êñ∞‰ª£ÁêÜÂ≠êËèúÂçï
        updateProxySubmenu();

        // Êõ¥Êñ∞Áä∂ÊÄÅÂ≠êËèúÂçï
        updateStatusSubmenu();

        // Êõ¥Êñ∞Â§öÈÄâÊó∂ÁöÑËèúÂçïÈ°πÊñáÊú¨
        if (selectedTokens.size > 1) {
          document.querySelector('.context-menu-item[onclick="viewDetails()"] span:first-child').textContent = "Êü•ÁúãËØ¶ÊÉÖ(Âçï‰∏™)";
          document.querySelector('.context-menu-item[onclick="refreshSelectedProfiles()"] span:first-child').textContent = `Âà∑Êñ∞Profile(Â∑≤ÈÄâ${selectedTokens.size}‰∏™)`;
          document.querySelector('.context-menu-item[onclick="upgradeSelectedTokens()"] span:first-child').textContent = `ÂçáÁ∫ßToken(Â∑≤ÈÄâ${selectedTokens.size}‰∏™)`;
          document.querySelector('.context-menu-item[onclick="openTimezoneSelector()"] span:first-child').textContent = `ËÆæÁΩÆÊó∂Âå∫(Â∑≤ÈÄâ${selectedTokens.size}‰∏™)`;
          document.querySelector('.context-menu-item.proxy-menu span:first-child').textContent = `ËÆæÁΩÆ‰ª£ÁêÜ(Â∑≤ÈÄâ${selectedTokens.size}‰∏™)`;
          document.querySelector('.context-menu-item[onclick="deleteSelectedTokens()"] span:first-child').textContent = `Âà†Èô§(Â∑≤ÈÄâ${selectedTokens.size}‰∏™)`;
        } else {
          document.querySelector('.context-menu-item[onclick="viewDetails()"] span:first-child').textContent = "Êü•ÁúãËØ¶ÊÉÖ";
          document.querySelector('.context-menu-item[onclick="refreshSelectedProfiles()"] span:first-child').textContent = "Âà∑Êñ∞Profile";
          document.querySelector('.context-menu-item[onclick="upgradeSelectedTokens()"] span:first-child').textContent = "ÂçáÁ∫ßToken";
          document.querySelector('.context-menu-item[onclick="openTimezoneSelector()"] span:first-child').textContent = "ËÆæÁΩÆÊó∂Âå∫";
          document.querySelector('.context-menu-item.proxy-menu span:first-child').textContent = "ËÆæÁΩÆ‰ª£ÁêÜ";
          document.querySelector('.context-menu-item[onclick="deleteSelectedTokens()"] span:first-child').textContent = "Âà†Èô§";
        }

        // ËÆ°ÁÆóËèúÂçï‰ΩçÁΩÆ
        positionContextMenu(contextMenu, e.clientX, e.clientY);
      });

      // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
      document.addEventListener('click', function (e) {
        if (!contextMenu.contains(e.target)) {
          contextMenu.style.display = 'none';
        }
      });
    }

    // ËÆ°ÁÆóÂíåËÆæÁΩÆËèúÂçï‰ΩçÁΩÆ
    function positionContextMenu(menu, x, y) {
      // È¶ñÂÖàÊòæÁ§∫ËèúÂçï‰ΩÜËÆæ‰∏∫‰∏çÂèØËßÅÔºå‰ª•‰æøËé∑ÂèñÂÖ∂Â∞∫ÂØ∏
      menu.style.display = 'block';
      menu.style.visibility = 'hidden';

      // Ëé∑ÂèñËèúÂçïÂ∞∫ÂØ∏ÂíåÁ™óÂè£Â∞∫ÂØ∏
      const menuRect = menu.getBoundingClientRect();
      const menuWidth = menuRect.width;
      const menuHeight = menuRect.height;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;

      // ËÆ°ÁÆóÊúÄ‰Ω≥‰ΩçÁΩÆ
      let posX = x;
      let posY = y;

      // Ê∞¥Âπ≥ÊñπÂêëË∞ÉÊï¥ - Â¶ÇÊûúËèúÂçï‰ºöË∂ÖÂá∫Âè≥ËæπÁïåÔºåÂàôÂêëÂ∑¶Â±ïÂºÄ
      if (x + menuWidth > windowWidth) {
        posX = windowWidth - menuWidth - 5; // 5pxÁöÑÂÆâÂÖ®ËæπË∑ù
      }

      // ÂûÇÁõ¥ÊñπÂêëË∞ÉÊï¥ - Â¶ÇÊûúËèúÂçï‰ºöË∂ÖÂá∫Â∫ïÈÉ®ËæπÁïåÔºåÂàôÂêë‰∏äÂ±ïÂºÄ
      if (y + menuHeight > windowHeight) {
        posY = windowHeight - menuHeight - 5; // 5pxÁöÑÂÆâÂÖ®ËæπË∑ù

        // Â¶ÇÊûúÂêë‰∏äÂ±ïÂºÄ‰πü‰∏çÂ§üÁ©∫Èó¥ÔºåÂ∞ΩÈáèÊòæÁ§∫Âú®ËßÜÂè£‰∏≠Â§Æ
        if (posY < 0) {
          posY = Math.max(5, (windowHeight - menuHeight) / 2);
        }
      }

      // Â∫îÁî®ËÆ°ÁÆóÂêéÁöÑ‰ΩçÁΩÆ
      menu.style.left = `${posX}px`;
      menu.style.top = `${posY}px`;
      menu.style.visibility = 'visible';

      // Ë∞ÉÊï¥Â≠êËèúÂçïÊñπÂêë
      adjustSubmenuPosition(menu, windowWidth, windowHeight);
    }

    // Ë∞ÉÊï¥Â≠êËèúÂçï‰ΩçÁΩÆ
    function adjustSubmenuPosition(menu, windowWidth, windowHeight) {
      const proxyMenu = menu.querySelector('.proxy-menu');
      if (!proxyMenu) return;

      // ÈáçÁΩÆÊñπÂêëÁ±ª
      proxyMenu.classList.remove('open-upward', 'open-leftward');

      // Ëé∑ÂèñËèúÂçïÈ°π‰ΩçÁΩÆ
      const menuItemRect = proxyMenu.getBoundingClientRect();
      const submenu = proxyMenu.querySelector('.proxy-submenu');

      // ÂÖà‰∏¥Êó∂ÊòæÁ§∫Â≠êËèúÂçï‰ª•Ëé∑ÂèñÂÖ∂Â∞∫ÂØ∏
      const originalVisibility = submenu.style.visibility;
      submenu.style.visibility = 'hidden';
      submenu.style.opacity = '1';

      const submenuRect = submenu.getBoundingClientRect();
      const submenuHeight = submenuRect.height;
      const submenuWidth = submenuRect.width;

      // ËøòÂéüÂ≠êËèúÂçïÁä∂ÊÄÅ
      submenu.style.visibility = originalVisibility;
      submenu.style.opacity = '';

      // Ê£ÄÊü•Âè≥‰æßÊòØÂê¶ÊúâË∂≥Â§üÁ©∫Èó¥
      const rightSpace = windowWidth - menuItemRect.right;
      if (rightSpace < submenuWidth) {
        proxyMenu.classList.add('open-leftward');
      }

      // Ê£ÄÊü•Â∫ïÈÉ®ÊòØÂê¶ÊúâË∂≥Â§üÁ©∫Èó¥
      const bottomSpace = windowHeight - menuItemRect.top;
      if (bottomSpace < submenuHeight) {
        // Â¶ÇÊûúÂ∫ïÈÉ®Á©∫Èó¥‰∏çÂ§üÔºåÊ£ÄÊü•È°∂ÈÉ®ÊòØÂê¶ÊúâË∂≥Â§üÁ©∫Èó¥
        const topSpace = menuItemRect.bottom;
        if (topSpace >= submenuHeight || topSpace > bottomSpace) {
          proxyMenu.classList.add('open-upward');
        }
      }
    }

    // Êõ¥Êñ∞‰ª£ÁêÜÂ≠êËèúÂçï
    function updateProxySubmenu() {
      const submenu = document.getElementById('proxySubmenu');
      if (!submenu) return;

      // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑtokenÂØπË±°
      const selectedTokenObjs = allTokens.filter(t => selectedTokens.has(t.token));
      const selectionSize = selectedTokenObjs.length;

      // ËÆ°ÁÆóÈÄâ‰∏≠È°π‰∏≠ÁöÑ‰ª£ÁêÜ‰ΩøÁî®ÊÉÖÂÜµ
      const selectedProxyUsage = { '': 0 }; // ÂàùÂßãÂåñ "Êú™ÊåáÂÆö" ËÆ°Êï∞
      proxyList.forEach(proxy => { selectedProxyUsage[proxy] = 0; }); // ÂàùÂßãÂåñÂ∑≤Áü•‰ª£ÁêÜËÆ°Êï∞

      selectedTokenObjs.forEach(token => {
        const proxy = token.tags?.proxy || ''; // Ëé∑ÂèñÈÄâ‰∏≠ token ÁöÑ‰ª£ÁêÜ
        // Á°Æ‰øùËÆ°Êï∞ÂØπË±°ÈáåÊúâËøô‰∏™key
        if (!(proxy in selectedProxyUsage)) {
          selectedProxyUsage[proxy] = 0;
        }
        selectedProxyUsage[proxy]++; // Â¢ûÂä†ÂØπÂ∫î‰ª£ÁêÜÁöÑËÆ°Êï∞
      });

      // ÊûÑÂª∫ "Êú™ÊåáÂÆö" ÈÄâÈ°π
      const isUnspecifiedActive = selectionSize > 0 && selectedProxyUsage[''] === selectionSize;
      let html = `
        <div class="context-menu-item ${isUnspecifiedActive ? 'active' : ''}" onclick="setProxy('')">
          <span>Êú™ÊåáÂÆö</span>
          <span class="proxy-count">${selectedProxyUsage['']}</span>
          <span class="check-mark"></span>
        </div>
        <div class="context-menu-divider"></div>
      `;

      // Ê∑ªÂä†ÊâÄÊúâÂèØÁî®‰ª£ÁêÜÈÄâÈ°π
      if (proxyList.length > 0) {
        proxyList.forEach(proxy => {
          if (!proxy) return; // Ë∑≥ËøáÁ©∫‰ª£ÁêÜÂêç
          const count = selectedProxyUsage[proxy] || 0; // Ëé∑ÂèñÈÄâ‰∏≠È°π‰∏≠‰ΩøÁî®Ëøô‰∏™‰ª£ÁêÜÁöÑÊï∞Èáè
          // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÈÄâ‰∏≠ÁöÑ Token ÈÉΩ‰ΩøÁî®‰∫ÜÊ≠§‰ª£ÁêÜ
          const isActive = selectionSize > 0 && count === selectionSize && proxy !== '';

          html += `
            <div class="context-menu-item ${isActive ? 'active' : ''}" onclick="setProxy('${proxy}')">
              <span>${proxy}</span>
              <span class="proxy-count">${count}</span>
              <span class="check-mark"></span>
            </div>
          `;
        });
      } else {
        html += `<div class="context-menu-item disabled"><span>Êó†ÂèØÁî®‰ª£ÁêÜ</span></div>`;
      }

      submenu.innerHTML = html;

      // Ê∑ªÂä† has-submenu Á±ª‰ª•‰æøÊòæÁ§∫ÁÆ≠Â§¥
      const proxyMenuEl = document.querySelector('.proxy-menu');
      if (proxyMenuEl) {
        proxyMenuEl.classList.add('has-submenu');
      }
    }

    // Ëé∑ÂèñToken‰ø°ÊÅØ
    async function getTokenInfo() {
      showToast('Ê≠£Âú®Âä†ËΩΩTokenÂàóË°®...', 'info');

      // ‰øùÂ≠òÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂
      const searchTerm = document.getElementById('searchInput').value;
      const membershipFilter = document.getElementById('membershipFilter').value;
      const usageMinValue = document.getElementById('usageMin').value;
      const usageMaxValue = document.getElementById('usageMax').value;
      const trialMinValue = document.getElementById('trialMin').value;
      const trialMaxValue = document.getElementById('trialMax').value;
      const profileFilter = document.getElementById('profileFilter').value;
      const proxyFilter = document.getElementById('proxyFilter').value;
      const timezoneFilter = document.getElementById('timezoneFilter').value; // ‰øùÂ≠òÊó∂Âå∫Á≠õÈÄâÊù°‰ª∂

      // Âà∑Êñ∞‰ª£ÁêÜÂàóË°®
      await getProxies();

      const data = await makeAuthenticatedRequest('/tokens/get');
      if (data && data.tokens) {
        allTokens = data.tokens;
        renderTokens(allTokens);
        updateStatusBar();
        updateProxyFilter(); // Êõ¥Êñ∞‰ª£ÁêÜÁ≠õÈÄâ‰∏ãÊãâÊ°Ü
        updateTimezoneFilter(); // Êõ¥Êñ∞Êó∂Âå∫Á≠õÈÄâ‰∏ãÊãâÊ°Ü
        updateStatusSubmenu(); // Êõ¥Êñ∞Áä∂ÊÄÅÂ≠êËèúÂçï

        // ÊÅ¢Â§çÁ≠õÈÄâÊù°‰ª∂
        document.getElementById('searchInput').value = searchTerm;
        document.getElementById('membershipFilter').value = membershipFilter;
        document.getElementById('usageMin').value = usageMinValue;
        document.getElementById('usageMax').value = usageMaxValue;
        document.getElementById('trialMin').value = trialMinValue;
        document.getElementById('trialMax').value = trialMaxValue;
        document.getElementById('profileFilter').value = profileFilter;
        document.getElementById('proxyFilter').value = proxyFilter;
        document.getElementById('timezoneFilter').value = timezoneFilter; // ÊÅ¢Â§çÊó∂Âå∫Á≠õÈÄâÊù°‰ª∂

        // Â∫îÁî®Á≠õÈÄâ
        filterTokens();

        showToast('TokenÂàóË°®Â∑≤Êõ¥Êñ∞', 'success');
      } else {
        showToast('Ëé∑ÂèñTokenÂàóË°®Â§±Ë¥•', 'error');
      }
    }

    // Êõ¥Êñ∞‰ª£ÁêÜÁ≠õÈÄâ‰∏ãÊãâÊ°Ü
    function updateProxyFilter() {
      const proxyFilterSelect = document.getElementById('proxyFilter');

      // ‰øùÊåÅÁ¨¨‰∏Ä‰∏™ÂíåÁ¨¨‰∫å‰∏™ÈÄâÈ°πÔºàÂÖ®ÈÉ®‰ª£ÁêÜÂíåÊú™ÊåáÂÆö‰ª£ÁêÜÔºâ
      while (proxyFilterSelect.options.length > 2) {
        proxyFilterSelect.remove(2);
      }

      // ‰ΩøÁî®ÂÖ¨ÂÖ±ÊñπÊ≥ïËé∑Âèñ‰ª£ÁêÜ‰ΩøÁî®ÁªüËÆ°
      const proxyUsage = getProxyUsageStats();

      // Ê∑ªÂä†‰ª£ÁêÜÈÄâÈ°π
      proxyList.forEach(proxy => {
        if (proxy) {  // Á°Æ‰øù‰ª£ÁêÜÂêç‰∏ç‰∏∫Á©∫
          const option = document.createElement('option');
          option.value = proxy;
          option.textContent = `${proxy} (${proxyUsage[proxy] || 0})`;
          proxyFilterSelect.appendChild(option);
        }
      });
    }

    // ËÆæÁΩÆ‰ª£ÁêÜ
    async function setProxy(proxyName) {
      if (selectedTokens.size === 0) {
        showToast('ËØ∑ÂÖàÈÄâÊã©Token', 'info');
        return;
      }

      const tokensToUpdate = [...selectedTokens];
      const tokensData = tokensToUpdate.map(token => {
        // Ëé∑ÂèñÂΩìÂâçtokenÁöÑÊó∂Âå∫ËÆæÁΩÆ
        const tokenObj = allTokens.find(t => t.token === token);
        const timezone = tokenObj.tags?.timezone || '';
        // ÊûÑÂª∫Êñ∞ÁöÑtagsÂØπË±°
        return {
          token,
          tags: {
            timezone: timezone || undefined,
            proxy: proxyName
          }
        };
      });

      showToast('Ê≠£Âú®Êõ¥Êñ∞‰ª£ÁêÜËÆæÁΩÆ...', 'info');
      const promises = tokensData.map(data =>
        makeAuthenticatedRequest('/tokens/tags/set', {
          method: 'POST',
          body: JSON.stringify({
            tokens: [data.token],
            tags: data.tags
          })
        })
      );

      try {
        await Promise.all(promises);
        showToast('‰ª£ÁêÜËÆæÁΩÆÊàêÂäü', 'success');
        getTokenInfo(); // Âà∑Êñ∞TokenÂàóË°®
      } catch (error) {
        showToast('‰ª£ÁêÜËÆæÁΩÆÂ§±Ë¥•', 'error');
      }
    }

    // Êõ¥Êñ∞ÁîüÊàêKeyÂØπËØùÊ°Ü‰∏≠ÁöÑ‰ª£ÁêÜÈÄâÊã©
    function updateProxySelect() {
      const proxySelect = document.getElementById('proxySelect');
      if (!proxySelect || proxyList.length === 0) return;

      // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°πÔºà‰øùÁïôÁ¨¨‰∏Ä‰∏™"Ë∑üÈöèTokenËÆæÁΩÆ"ÈÄâÈ°πÔºâ
      while (proxySelect.options.length > 1) {
        proxySelect.remove(1);
      }

      // Ê∑ªÂä†‰ª£ÁêÜÈÄâÈ°π
      proxyList.forEach(proxy => {
        const option = document.createElement('option');
        option.value = proxy;
        option.textContent = proxy;
        proxySelect.appendChild(option);
      });
    }

    // Ê∏≤ÊüìTokenÂàóË°®
    function renderTokens(tokens) {
      const fileListBody = document.getElementById('fileListBody');
      const emptyState = document.getElementById('emptyState');

      if (tokens.length === 0) {
        fileListBody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      fileListBody.innerHTML = tokens.map((token, index) => {
        const profile = token.profile || {};
        const user = profile.user || {};
        const stripe = profile.stripe || {};
        const usage = profile.usage || {};
        const premium = usage.premium || {};

        const email = user.email || '';
        const displayName = email || token.token.substring(0, 15) + '...';
        const timezone = token.tags?.timezone || ''; // Ëé∑ÂèñÊó∂Âå∫

        return `
          <tr data-token="${token.token}" data-checksum="${token.checksum}" data-index="${index}" class="${selectedTokens.has(token.token) ? 'selected' : ''}">
            <td>
              <span class="status-indicator ${token.status === 'disabled' ? 'status-disabled' : token.status === undefined ? 'status-enabled' : 'status-' + token.status}"></span>
              <span class="file-icon">üîë</span>
              ${displayName}
            </td>
            <td>${formatMembershipType(stripe.membership_type)}</td>
            <td>${premium.requests || 0}/${premium.max_requests || '‚àû'}</td>
            <td>${stripe.days_remaining_on_trial > 0 ? `${stripe.days_remaining_on_trial}Â§©` : '-'}</td>
            <td><span class="timezone-name" onclick="openTimezoneSelectorForToken('${token.token}', event)">${timezone || 'Êú™ÊåáÂÆö'}</span></td>
            <td><span class="proxy-name" onclick="openProxySelector('${displayName}','${token.token}', event)">${token.tags?.proxy || 'Êú™ÊåáÂÆö'}</span></td>
          </tr>
        `;
      }).join('');

      // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
      const rows = document.querySelectorAll('#fileListBody tr');
      rows.forEach(row => {
        row.addEventListener('click', function (e) {

          // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØ‰ª£ÁêÜÂêçÁß∞ÊàñÊó∂Âå∫ÂêçÁß∞Ôºå‰∏çÂ§ÑÁêÜË°åÈÄâÊã©
          if (e.target.classList.contains('proxy-name') || e.target.classList.contains('timezone-name')) {
            return;
          }

          const row = e.target.closest('tr');
          if (!row) return;

          const token = this.dataset.token;
          const index = parseInt(this.dataset.index);

          const modifierKey = isModifierKey(e);

          if (e.shiftKey && lastSelectedIndex !== -1) {
            // Shift+ÁÇπÂáªÂÆûÁé∞ËåÉÂõ¥ÈÄâÊã©
            const start = Math.min(lastSelectedIndex, index);
            const end = Math.max(lastSelectedIndex, index);

            clearSelection();

            for (let i = start; i <= end; i++) {
              const rowToken = rows[i].dataset.token;
              selectToken(rowToken);
            }
          } else if (modifierKey) {
            // Ctrl+ÁÇπÂáªÂÆûÁé∞Â§öÈÄâ
            if (selectedTokens.has(token)) {
              deselectToken(token);
            } else {
              selectToken(token, true);
              lastSelectedIndex = index;
            }
          } else {
            // ÊôÆÈÄöÁÇπÂáª
            clearSelection();
            selectToken(token);
            lastSelectedIndex = index;
          }

          updateSelectionStatus();

        });
      });

      // ÂèåÂáªÊü•ÁúãËØ¶ÊÉÖ
      fileListBody.addEventListener('dblclick', function (e) {
        const row = e.target.closest('tr');
        if (!row) return;

        const token = row.dataset.token;
        selectToken(token);
        viewDetails();
      });

      updateSelectionStatus();
      // Êõ¥Êñ∞‰ª£ÁêÜÂ≠êËèúÂçï
      updateProxySubmenu();
    }

    // ‰∏∫Âçï‰∏™TokenÊâìÂºÄÊó∂Âå∫ÈÄâÊã©Âô®
    function openTimezoneSelectorForToken(token, event) {
      // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëË°åÈÄâÊã©
      event.stopPropagation();

      // ÈÄâ‰∏≠ËØ•Token
      clearSelection();
      selectToken(token);

      // ÊâìÂºÄÊó∂Âå∫ÈÄâÊã©Âô®
      openTimezoneSelector();
    }

    // Á≠õÈÄâToken
    function filterTokens() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const membershipFilter = document.getElementById('membershipFilter').value;
      const usageMinValue = document.getElementById('usageMin').value;
      const usageMaxValue = document.getElementById('usageMax').value;
      const trialMinValue = document.getElementById('trialMin').value;
      const trialMaxValue = document.getElementById('trialMax').value;
      const profileFilter = document.getElementById('profileFilter').value;
      const proxyFilter = document.getElementById('proxyFilter').value;
      const timezoneFilter = document.getElementById('timezoneFilter').value;  // Êñ∞Â¢ûÊó∂Âå∫Á≠õÈÄâ

      const filteredTokens = allTokens.filter(token => {
        const profile = token.profile || {};
        const user = profile.user || {};
        const stripe = profile.stripe || {};
        const usage = profile.usage || {};
        const premium = usage.premium || {};

        // ÊêúÁ¥¢Êù°‰ª∂
        const emailMatch = (user.email || '').toLowerCase().includes(searchTerm);
        const tokenMatch = (token.token || '').toLowerCase().includes(searchTerm);
        const searchMatch = searchTerm === '' || emailMatch || tokenMatch;

        // ‰ºöÂëòÁ±ªÂûãÁ≠õÈÄâ
        const membershipType = stripe.membership_type || '';
        let membershipMatch = true;
        if (membershipFilter !== 'all') {
          membershipMatch = membershipType === membershipFilter;
        }

        // ‰ΩøÁî®ÈáèÂå∫Èó¥Á≠õÈÄâ
        let usageMatch = true;
        const currentUsage = premium.requests || 0;
        if (usageMinValue !== '') {
          usageMatch = usageMatch && currentUsage >= parseInt(usageMinValue);
        }
        if (usageMaxValue !== '') {
          usageMatch = usageMatch && currentUsage <= parseInt(usageMaxValue);
        }

        // ËØïÁî®ÊúüÂå∫Èó¥Á≠õÈÄâ
        let trialMatch = true;
        const daysRemaining = stripe.days_remaining_on_trial || 0;
        if (trialMinValue !== '') {
          trialMatch = trialMatch && daysRemaining >= parseInt(trialMinValue);
        }
        if (trialMaxValue !== '') {
          trialMatch = trialMatch && daysRemaining <= parseInt(trialMaxValue);
        }

        // ProfileÁ≠õÈÄâ
        let profileMatch = true;
        if (profileFilter === 'has_profile') {
          profileMatch = Object.keys(profile).length > 0;
        } else if (profileFilter === 'no_profile') {
          profileMatch = Object.keys(profile).length === 0;
        }

        // ‰ª£ÁêÜÁ≠õÈÄâ
        let proxyMatch = true;
        if (proxyFilter !== 'all') {
          const tokenProxy = token.tags?.proxy || '';
          if (proxyFilter === 'none') {
            proxyMatch = tokenProxy === '';
          } else {
            proxyMatch = tokenProxy === proxyFilter;
          }
        }

        // Êó∂Âå∫Á≠õÈÄâ
        let timezoneMatch = true;
        if (timezoneFilter !== 'all') {
          const tokenTimezone = token.tags?.timezone || '';
          if (timezoneFilter === 'none') {
            timezoneMatch = tokenTimezone === '';
          } else {
            timezoneMatch = tokenTimezone === timezoneFilter;
          }
        }

        return searchMatch && membershipMatch && usageMatch && trialMatch && profileMatch && proxyMatch && timezoneMatch;
      });

      renderTokens(filteredTokens);

      // Âú®Áä∂ÊÄÅÊ†èÊòæÁ§∫Á≠õÈÄâÁªìÊûú
      updateStatusBar(filteredTokens.length);
    }

    // Êõ¥Êñ∞Áä∂ÊÄÅÊ†è
    function updateStatusBar(filteredCount) {
      const total = allTokens.length;
      const selected = selectedTokens.size;
      const selectionStatus = document.getElementById('selectionStatus');
      const totalCount = document.getElementById('totalCount');

      if (selectionStatus) selectionStatus.textContent = `Â∑≤ÈÄâÊã©: ${selected} ‰∏™È°πÁõÆ`;
      if (totalCount) {
        // ‰ΩøÁî®!== undefinedÂà§Êñ≠ÔºåËøôÊ†∑Âç≥‰ΩøfilteredCount‰∏∫0‰πü‰ºöÊ≠£Á°ÆÊòæÁ§∫
        totalCount.textContent = `ÂÖ± ${filteredCount !== undefined ? filteredCount : total} ‰∏™Token`;
      }
    }

    // Ê†ºÂºèÂåñ‰ºöÂëòÁ±ªÂûã
    function formatMembershipType(type) {
      if (!type) return '-';
      const types = {
        'free': 'ÂÖçË¥πÁâà',
        'free_trial': 'ËØïÁî®Áâà',
        'pro': '‰∏ì‰∏öÁâà',
        'enterprise': '‰ºÅ‰∏öÁâà'
      };
      return types[type] || type;
    }

    // ÈÄâÊã©Token
    function selectToken(token, append = false) {

      if (!token) return;

      if (!append) {
        clearSelection();
      }

      selectedTokens.add(token);
      const row = document.querySelector(`tr[data-token="${token}"]`);
      if (row) {
        row.classList.add('selected');
      }

      updateSelectionStatus();
    }

    // ÂèñÊ∂àÈÄâÊã©Token
    function deselectToken(token) {
      if (!token) return;

      selectedTokens.delete(token);
      const row = document.querySelector(`tr[data-token="${token}"]`);
      if (row) {
        row.classList.remove('selected');
      }

      updateSelectionStatus();
    }

    // Ê∏ÖÈô§ÊâÄÊúâÈÄâÊã©
    function clearSelection() {
      selectedTokens.clear();
      const rows = document.querySelectorAll('#fileListBody tr.selected');
      rows.forEach(row => {
        row.classList.remove('selected');
      });

      updateSelectionStatus();
    }

    // ÈÄâÊã©ÊâÄÊúâToken
    function selectAllTokens() {
      clearSelection();

      const rows = document.querySelectorAll('#fileListBody tr');
      rows.forEach(row => {
        const token = row.dataset.token;
        selectedTokens.add(token);
        row.classList.add('selected');
      });

      updateSelectionStatus();
    }

    // Êõ¥Êñ∞ÈÄâÊã©Áä∂ÊÄÅ
    function updateSelectionStatus() {
      updateStatusBar();

      // Â¶ÇÊûúÂè™ÈÄâÊã©‰∫Ü‰∏Ä‰∏™TokenÔºåÊõ¥Êñ∞ËØ¶ÊÉÖ
      if (selectedTokens.size === 1) {
        updateDetailsPanel([...selectedTokens][0]);
      }
    }

    // Êü•ÁúãTokenËØ¶ÊÉÖ
    function viewDetails() {
      if (selectedTokens.size === 0) return;

      // Â¶ÇÊûúÈÄâÊã©‰∫ÜÂ§ö‰∏™TokenÔºåÂè™ÊòæÁ§∫Á¨¨‰∏Ä‰∏™
      const token = [...selectedTokens][0];
      updateDetailsPanel(token);
      toggleDetailsPanel(true);
      // ÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
      document.getElementById('contextMenu').style.display = 'none';
    }

    // Êõ¥Êñ∞ËØ¶ÊÉÖÈù¢Êùø
    function updateDetailsPanel(token) {
      const tokenObj = allTokens.find(t => t.token === token);
      if (!tokenObj) return;

      const profile = tokenObj.profile || {};
      const user = profile.user || {};
      const stripe = profile.stripe || {};
      const usage = profile.usage || {};
      const premium = usage.premium || {};
      const timezone = tokenObj.tags?.timezone || '-';
      const proxy = tokenObj.tags?.proxy || '-';

      document.getElementById('detailsTitle').textContent = user.email || 'Êú™Áü•Ë¥¶Êà∑';

      const content = document.getElementById('detailsContent');
      content.innerHTML = `
          <div class="details-property">
            <div class="details-property-name">Token</div>
            <div class="details-property-value">${tokenObj.token}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">Checksum</div>
            <div class="details-property-value">${tokenObj.checksum || '-'}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">Êó∂Âå∫</div>
            <div class="details-property-value">${timezone}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">‰ª£ÁêÜ</div>
            <div class="details-property-value">${proxy}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">‰ºöÂëòÁ±ªÂûã</div>
            <div class="details-property-value">${formatMembershipType(stripe.membership_type)}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">Premium Áî®Èáè</div>
            <div class="details-property-value">${premium.requests || 0}/${premium.max_requests || '‚àû'}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">ËØïÁî®Ââ©‰Ωô</div>
            <div class="details-property-value">${stripe.days_remaining_on_trial > 0 ? `${stripe.days_remaining_on_trial}Â§©` : '-'}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">Áî®Êà∑ ID</div>
            <div class="details-property-value">${user.id || '-'}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">ÂàõÂª∫Êó∂Èó¥</div>
            <div class="details-property-value">${formatDate(user.created_at) || '-'}</div>
          </div>
          <div class="details-property">
            <div class="details-property-name">Êõ¥Êñ∞Êó∂Èó¥</div>
            <div class="details-property-value">${formatDate(user.updated_at) || '-'}</div>
          </div>
        `;
    }

    // ÂàáÊç¢ËØ¶ÊÉÖÈù¢ÊùøÊòæÁ§∫
    function toggleDetailsPanel(show) {
      const panel = document.getElementById('detailsPanel');
      if (show) {
        panel.classList.add('open');
        document.body.style.overflow = 'hidden'; // Á¶ÅÁî®‰∏ª‰ΩìÈ°µÈù¢ÊªöÂä®
        detailsPanelOpen = true;
      } else {
        panel.classList.remove('open');
        document.body.style.overflow = ''; // ÊÅ¢Â§ç‰∏ª‰ΩìÈ°µÈù¢ÊªöÂä®
        detailsPanelOpen = false;
      }
    }

    // Ê†ºÂºèÂåñÊó•Êúü
    function formatDate(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN');
      } catch (e) {
        return dateString;
      }
    }

    // Â§çÂà∂TokenÂà∞Ââ™Ë¥¥Êùø
    // Ê∑ªÂä†ÂÖºÂÆπÊÄßÊ£ÄÊü•ÂíåÂ§áÁî®ÊñπÊ≥ï
    function copyTokenToClipboard() {
      if (selectedTokens.size === 0) {
        showToast('ËØ∑ÂÖàÈÄâÊã©Token', 'info');
        return;
      }

      const tokensToCopy = [...selectedTokens].join('\n');

      // Ê£ÄÊü•navigator.clipboardÊòØÂê¶ÂèØÁî®
      if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        navigator.clipboard.writeText(tokensToCopy)
          .then(() => {
            showToast(`Â∑≤Â§çÂà∂ ${selectedTokens.size} ‰∏™TokenÂà∞Ââ™Ë¥¥Êùø`, 'success');
          })
          .catch(err => {
            // Â¶ÇÊûúÂâ™Ë¥¥ÊùøAPIÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï
            fallbackCopy(tokensToCopy);
          });
      } else {
        // ÊµèËßàÂô®‰∏çÊîØÊåÅclipboard APIÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ≥ï
        fallbackCopy(tokensToCopy);
      }

      // ÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
      document.getElementById('contextMenu').style.display = 'none';
    }

    // Â§áÁî®Â§çÂà∂ÊñπÊ≥ï
    function fallbackCopy(text) {
      // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÊñáÊú¨Âå∫Âüü
      const textArea = document.createElement('textarea');
      textArea.value = text;

      // ËÆæÁΩÆÊñáÊú¨Âå∫ÂüüÁöÑÊ†∑ÂºèÔºå‰ΩøÂÖ∂‰∏çÂèØËßÅ
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);

      // ÈÄâÊã©ÊñáÊú¨Âπ∂Â§çÂà∂
      textArea.focus();
      textArea.select();

      let success = false;
      try {
        // ÊâßË°åÂ§çÂà∂ÂëΩ‰ª§
        success = document.execCommand('copy');
      } catch (err) {
        console.error('Â§çÂà∂Â§±Ë¥•:', err);
      }

      // ÁßªÈô§‰∏¥Êó∂ÂÖÉÁ¥†
      document.body.removeChild(textArea);

      // ÊòæÁ§∫Â§çÂà∂ÁªìÊûú
      if (success) {
        showToast(`Â∑≤Â§çÂà∂ ${selectedTokens.size} ‰∏™TokenÂà∞Ââ™Ë¥¥Êùø`, 'success');
      } else {
        showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
      }
    }
    // Âà†Èô§ÈÄâ‰∏≠ÁöÑToken
    function deleteSelectedTokens(singleToken) {
      // Â¶ÇÊûúÊèê‰æõ‰∫ÜÂçï‰∏™TokenÔºåÂàôÂè™Âà†Èô§ËØ•Token
      if (singleToken) {
        tokensToDelete = [singleToken];
      } else {
        tokensToDelete = [...selectedTokens];

        if (tokensToDelete.length === 0) {
          showToast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑToken', 'info');
          return;
        }
      }

      const count = tokensToDelete.length;
      document.getElementById('confirmMessage').textContent =
        count > 1 ? `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${count} ‰∏™TokenÂêóÔºü` : 'Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑTokenÂêóÔºü';

      showModal('confirmModal');

      // ÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
      document.getElementById('contextMenu').style.display = 'none';
    }

    // Á°ÆËÆ§Âà†Èô§Token
    async function confirmDeleteTokens() {
      if (tokensToDelete.length === 0) return;

      closeModal('confirmModal');
      showToast('Ê≠£Âú®Âà†Èô§Token...', 'info');

      const data = await makeAuthenticatedRequest('/tokens/del', {
        body: JSON.stringify({
          tokens: tokensToDelete,
          expectation: 'failed_tokens'
        })
      });

      if (data) {
        const failedCount = data.failed_tokens?.length || 0;
        const successCount = tokensToDelete.length - failedCount;
        const message = `Âà†Èô§ÊàêÂäü: ${successCount} ‰∏™Token${failedCount ? `ÔºåÂ§±Ë¥•: ${failedCount} ‰∏™` : ''}`;

        showToast(message, 'success');
        clearSelection();
        getTokenInfo();
      } else {
        showToast('Âà†Èô§Â§±Ë¥•', 'error');
      }

      tokensToDelete = [];
    }

    // Âà∑Êñ∞ÈÄâ‰∏≠TokenÁöÑProfile
    async function refreshSelectedProfiles() {
      if (selectedTokens.size === 0) {
        showToast('ËØ∑ÂÖàÈÄâÊã©Token', 'info');
        return;
      }

      const tokensToRefresh = [...selectedTokens];
      showToast(`Ê≠£Âú®Âà∑Êñ∞ ${tokensToRefresh.length} ‰∏™TokenÁöÑProfile...`, 'info');

      // ÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
      document.getElementById('contextMenu').style.display = 'none';

      const data = await makeAuthenticatedRequest('/tokens/profile/update', {
        body: JSON.stringify(tokensToRefresh)
      });

      if (data) {
        showToast(`Âà∑Êñ∞ÂÆåÊàê: ${data.message}`, 'success');
        getTokenInfo();
      } else {
        showToast('Âà∑Êñ∞Â§±Ë¥•', 'error');
      }
    }

    // ÊâπÈáèÊ∑ªÂä†Token
    function addTokens() {
      showModal('addTokensModal');
    }

    // Á°ÆËÆ§Ê∑ªÂä†Token
    async function confirmAddTokens() {
      const tokensInput = document.getElementById('addTokensInput').value;
      const status = document.getElementById('addTokensStatus').value;

      if (!tokensInput) {
        showToast('ËØ∑ËæìÂÖ•Ë¶ÅÊ∑ªÂä†ÁöÑToken', 'warning');
        return;
      }

      closeModal('addTokensModal');
      showToast('Ê≠£Âú®Ê∑ªÂä†Token...', 'info');

      // Â§ÑÁêÜËæìÂÖ•ÁöÑtokensÔºåË∑≥ËøáÁ©∫Ë°åÂíåÊ≥®ÈáäÔºåËß£ÊûêtokenÂíåchecksum
      const tokenList = tokensInput.split('\n')
        .map(line => line.trim())
        .filter(line => line && !line.startsWith('#'))
        .map(line => {
          const parts = line.includes(',') ? line.split(',') : [line];
          return {
            token: parts[0].trim(),
            checksum: parts[1]?.trim() || null,
            status: status
          };
        });

      const data = await makeAuthenticatedRequest('/tokens/add', {
        body: JSON.stringify({
          tokens: tokenList,
          tags: {},
          status: status
        })
      });

      if (data) {
        showToast(`Ê∑ªÂä†ÊàêÂäü: ${data.message}`, 'success');
        document.getElementById('addTokensInput').value = '';
        getTokenInfo();
      } else {
        showToast('Ê∑ªÂä†Â§±Ë¥•', 'error');
      }
    }

    // ÂØºÂá∫TokenÂàóË°®
    function exportTokens() {
      const jsonData = JSON.stringify(allTokens, null, 2);
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'tokens_export.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('TokenÂàóË°®Â∑≤ÂØºÂá∫', 'success');
    }

    // ÂØºÂÖ•TokenÂàóË°®
    function importTokens() {
      showModal('importModal');
    }

    // Á°ÆËÆ§ÂØºÂÖ•
    async function confirmImport() {
      const fileInput = document.getElementById('importFile');

      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('ËØ∑ÈÄâÊã©Ë¶ÅÂØºÂÖ•ÁöÑÊñá‰ª∂', 'warning');
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function (e) {
        try {
          const tokensJson = JSON.parse(e.target.result);

          if (!Array.isArray(tokensJson)) {
            throw new Error('ÂØºÂÖ•ÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫î‰∏∫Êï∞ÁªÑ');
          }

          const isValid = tokensJson.every(tokenObj => {
            return typeof tokenObj.token === 'string' &&
              typeof tokenObj.checksum === 'string' &&
              typeof tokenObj.profile === 'object' &&
              typeof tokenObj.profile.usage === 'object' &&
              typeof tokenObj.profile.user === 'object' &&
              typeof tokenObj.profile.stripe === 'object' &&
              Array.isArray(tokenObj.tags);
          });

          if (!isValid) {
            throw new Error('ÂØºÂÖ•ÁöÑÊï∞ÊçÆÁªìÊûÑ‰∏çÁ¨¶ÂêàË¶ÅÊ±ÇÔºåËØ∑Ê£ÄÊü•ÂêéÈáçËØï');
          }

          closeModal('importModal');
          showToast('Ê≠£Âú®ÂØºÂÖ•Token...', 'info');

          const data = await makeAuthenticatedRequest('/tokens/set', {
            body: JSON.stringify(tokensJson)
          });

          if (data) {
            showToast('TokenÂàóË°®ÂØºÂÖ•ÊàêÂäü', 'success');
            fileInput.value = '';
            getTokenInfo();
          } else {
            showToast('ÂØºÂÖ•Â§±Ë¥•ÔºåÊúçÂä°Âô®Êú™ËøîÂõûÊúâÊïàÂìçÂ∫î', 'error');
          }
        } catch (error) {
          showToast('ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'error');
        }
      };

      reader.readAsText(file);
    }

    // ÁîüÊàêKey
    function generateKey(token, checksum) {
      // Â¶ÇÊûúÊú™Êèê‰æõtokenÔºåÂàô‰ΩøÁî®ÈÄâ‰∏≠ÁöÑtoken
      if (!token && selectedTokens.size === 0) {
        showToast('ËØ∑ÂÖàÈÄâÊã©Token', 'info');
        return;
      }

      const tokenToUse = token || [...selectedTokens][0];
      const checksumToUse = checksum || allTokens.find(t => t.token === tokenToUse)?.checksum || '';

      document.getElementById('keyToken').textContent = tokenToUse;

      // ÈáçÁΩÆË°®Âçï
      document.getElementById('disableVision').value = '';
      document.getElementById('enableSlowPool').value = '';
      document.getElementById('usageCheckType').value = '';
      document.getElementById('includeWebReferences').value = '';
      document.getElementById('keyContent').textContent = '';
      document.getElementById('keyResult').style.display = 'none';

      // Êõ¥Êñ∞‰ª£ÁêÜÈÄâÊã©‰∏ãÊãâÊ°Ü
      updateProxySelect();

      showModal('keyModal');

      // ÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
      document.getElementById('contextMenu').style.display = 'none';
    }

    // ÁîüÊàêKeyÊèê‰∫§
    async function generateKeySubmit() {
      const token = document.getElementById('keyToken').textContent;
      const tokenObj = allTokens.find(t => t.token === token);

      if (!token || !tokenObj) {
        showToast('Áº∫Â∞ëToken', 'error');
        return;
      }

      const disableVision = document.getElementById('disableVision').value;
      const enableSlowPool = document.getElementById('enableSlowPool').value;
      const usageCheckType = document.getElementById('usageCheckType').value;
      const includeWebReferences = document.getElementById('includeWebReferences').value;
      const proxyName = document.getElementById('proxySelect').value;

      // ÊûÑÂª∫ËØ∑Ê±Ç‰Ωì
      const requestBody = {
        auth_token: tokenObj.checksum ? `${token},${tokenObj.checksum}` : token
      };

      // Ê∑ªÂä†ÂèØÈÄâÂèÇÊï∞
      if (disableVision) {
        requestBody.disable_vision = disableVision === 'true';
      }
      if (enableSlowPool) {
        requestBody.enable_slow_pool = enableSlowPool === 'true';
      }
      if (includeWebReferences) {
        requestBody.include_web_references = includeWebReferences === 'true';
      }

      // Â¶ÇÊûúÈÄâÊã©‰∫ÜÁâπÂÆö‰ª£ÁêÜÔºåÂàô‰ΩøÁî®ÈÄâÊã©ÁöÑ‰ª£ÁêÜ
      if (proxyName) {
        requestBody.proxy_name = proxyName;
      } else {
        // Âê¶Âàô‰ΩøÁî®TokenÁöÑtags‰∏≠ËÆæÁΩÆÁöÑ‰ª£ÁêÜ
        const tags = tokenObj.tags || {};
        const tokenProxyName = tags.proxy || '';
        if (tokenProxyName) {
          requestBody.proxy_name = tokenProxyName;
        }
      }

      if (usageCheckType) {
        requestBody.usage_check_models = {
          type: usageCheckType
        };

        if (usageCheckType === 'custom') {
          const selectedModels = Array.from(document.querySelectorAll('#modelListContainer input:checked'))
            .map(input => input.value);
          if (selectedModels.length > 0) {
            requestBody.usage_check_models.model_ids = selectedModels.join(',');
          }
        }
      }

      try {
        const response = await makeAuthenticatedRequest('/build-key', {
          method: 'POST',
          body: JSON.stringify(requestBody)
        });

        if (response && response.key) {
          document.getElementById('keyContent').textContent = response.key;
          document.getElementById('keyResult').style.display = 'block';
          showToast('KeyÂ∑≤ÁîüÊàêÔºåÁÇπÂáªÂ§çÂà∂', 'success');
        } else {
          showToast('ÁîüÊàêKeyÂ§±Ë¥•: ' + (response.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showToast('ÁîüÊàêKeyÂ§±Ë¥•: ' + error.message, 'error');
      }
    }

    // Â§çÂà∂ÁîüÊàêÁöÑKey
    function copyGeneratedKey() {
      const key = document.getElementById('keyContent').textContent;

      if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        navigator.clipboard.writeText(key)
          .then(() => {
            showToast('KeyÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
          })
          .catch(err => {
            fallbackCopy(key);
          });
      } else {
        fallbackCopy(key);
      }
    }
    // Ëé∑ÂèñÊ®°ÂûãÂàóË°®
    async function getModels() {
      const data = await (await fetch('/health')).json();
      if (data && data.models) {
        availableModels = data.models;

        // Â°´ÂÖÖÊ®°ÂûãÂàóË°®
        renderModelList();
      }
    }

    // Ê∏≤ÊüìÊ®°ÂûãÂàóË°®
    function renderModelList() {
      const container = document.getElementById('modelListContainer');

      container.innerHTML = availableModels.map(model => `
          <div class="model-item">
            <input type="checkbox" id="model_${model}" value="${model}">
            <label for="model_${model}">${model}</label>
          </div>
        `).join('');
    }

    // ÂàáÊç¢Ê®°ÂûãÂàóË°®ÊòæÁ§∫
    function toggleModelList() {
      const usageCheckType = document.getElementById('usageCheckType').value;
      const container = document.getElementById('modelListContainer');

      if (usageCheckType === 'custom') {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    // ÊòæÁ§∫ÂØπËØùÊ°Ü
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);

      if (modal && backdrop) {
        modal.style.display = 'block';
        backdrop.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Á¶ÅÁî®‰∏ª‰ΩìÈ°µÈù¢ÊªöÂä®
      }
    }

    // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      const backdrop = document.getElementById(`${modalId}-backdrop`);
      document.body.style.overflow = ''; // ÊÅ¢Â§ç‰∏ª‰ΩìÈ°µÈù¢ÊªöÂä®

      if (modal && backdrop) {
        modal.style.display = 'none';
        backdrop.style.display = 'none';
      }
    }

    // ÂÖ≥Èó≠ÊâÄÊúâÂØπËØùÊ°Ü
    function closeAllModals() {
      const modals = document.querySelectorAll('.modal');
      const backdrops = document.querySelectorAll('.modal-backdrop');
      document.body.style.overflow = ''; // ÊÅ¢Â§ç‰∏ª‰ΩìÈ°µÈù¢ÊªöÂä®

      modals.forEach(modal => {
        modal.style.display = 'none';
      });

      backdrops.forEach(backdrop => {
        backdrop.style.display = 'none';
      });
    }

    // Ëé∑Âèñ‰ª£ÁêÜÂàóË°®
    async function getProxies() {
      try {
        const data = await makeAuthenticatedRequest('/proxies/get');
        if (data && data.proxies) {
          // ‰ªé‰ª£ÁêÜÂØπË±°‰∏≠ÊèêÂèñ‰ª£ÁêÜÂêçÁß∞ÂàóË°®
          proxyList = Object.keys(data.proxies.proxies || {});
          currentProxy = data.general_proxy || '';
          return true;
        }
      } catch (error) {
        console.error('Ëé∑Âèñ‰ª£ÁêÜÂàóË°®Â§±Ë¥•:', error);
      }
      return false;
    }

    // ÊòæÁ§∫ÈÄöÁü•Ê∂àÊÅØ
    // ÊòæÁ§∫ÈÄöÁü•Ê∂àÊÅØ‰ºòÂåñÁâàÊú¨
    function showToast(message, type = 'info', duration = 3000) {
      // Ëé∑ÂèñÊàñÂàõÂª∫ÈÄöÁü•ÂÆπÂô®
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container';
        document.body.appendChild(container);
      }

      // ÂàõÂª∫Êñ∞ÁöÑÈÄöÁü•ÂÖÉÁ¥†
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      // Ê∑ªÂä†ÊñáÊú¨ÂÆπÂô®
      toast.innerHTML = `<div class="toast-content">${message}</div>`;

      // Ê∑ªÂä†Âà∞ÂÆπÂô®
      container.appendChild(toast);

      // Âº∫Âà∂‰∏ÄÊ¨°ÈáçÊéí
      void toast.offsetWidth;

      // ÊòæÁ§∫ÈÄöÁü•Ôºå‰ΩøÁî®requestAnimationFrameÁ°Æ‰øùÂπ≥ÊªëËøáÊ∏°
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });

      // ËÆæÁΩÆËá™Âä®ÁßªÈô§
      setTimeout(() => {
        toast.classList.remove('show');

        // ÈÄöÁü•Ê∂àÂ§±Âä®ÁîªÂÆåÊàêÂêéÁßªÈô§ÂÖÉÁ¥†
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }

          // Â¶ÇÊûúÊ≤°ÊúâÊõ¥Â§öÈÄöÁü•ÔºåÁßªÈô§ÂÆπÂô®
          if (container.children.length === 0) {
            if (document.body.contains(container)) {
              document.body.removeChild(container);
            }
          }
        }, 400);
      }, duration);

      // ÈôêÂà∂ÊúÄÂ§ßÊòæÁ§∫Êï∞ÈáèÔºåÂ¶ÇÊûúË∂ÖËøáÂàôÁßªÈô§ÊúÄÊó©ÁöÑ
      const maxToasts = 5; // ÊúÄÂ§ßÂêåÊó∂ÊòæÁ§∫ÁöÑÈÄöÁü•Êï∞
      const toasts = container.querySelectorAll('.toast');
      if (toasts.length > maxToasts) {
        const oldestToast = toasts[0]; // ÊúÄÊó©ÁöÑÈÄöÁü•
        oldestToast.classList.remove('show');
        setTimeout(() => {
          if (container.contains(oldestToast)) {
            container.removeChild(oldestToast);
          }
        }, 400);
      }
    }

    // ÊâìÂºÄ‰ª£ÁêÜÈÄâÊã©Âô®
    function openProxySelector(displayName, token, event) {
      // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëË°åÈÄâÊã©
      event.stopPropagation();

      const tokenObj = allTokens.find(t => t.token === token);
      if (!tokenObj) return;

      currentEditingToken = token;

      // ÊòæÁ§∫ÂΩìÂâçtoken‰ø°ÊÅØ
      document.getElementById('currentTokenDisplay').textContent = displayName;

      // Â°´ÂÖÖ‰ª£ÁêÜ‰∏ãÊãâÊ°Ü
      const proxySelect = document.getElementById('proxySelectDropdown');

      // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°πÔºà‰øùÁïôÁ¨¨‰∏Ä‰∏™"Êú™ÊåáÂÆö"ÈÄâÈ°πÔºâ
      while (proxySelect.options.length > 1) {
        proxySelect.remove(1);
      }

      // ‰ΩøÁî®ÂÖ¨ÂÖ±ÊñπÊ≥ïËé∑Âèñ‰ª£ÁêÜ‰ΩøÁî®ÁªüËÆ°
      const proxyUsage = getProxyUsageStats();

      // Ê∑ªÂä†‰ª£ÁêÜÈÄâÈ°π
      proxyList.forEach(proxy => {
        const option = document.createElement('option');
        option.value = proxy;
        option.textContent = `${proxy} (${proxyUsage[proxy] || 0})`;
        proxySelect.appendChild(option);
      });

      // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰ª£ÁêÜ
      const currentProxy = tokenObj.tags?.proxy || '';
      proxySelect.value = currentProxy;

      // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
      showModal('proxySelectModal');
    }

    // ‰øùÂ≠ò‰ª£ÁêÜÈÄâÊã©
    async function saveProxySelection() {
      if (!currentEditingToken) return;

      closeModal('proxySelectModal')

      const selectedProxy = document.getElementById('proxySelectDropdown').value;
      const tags = { proxy: selectedProxy || undefined };

      showToast('Ê≠£Âú®Êõ¥Êñ∞‰ª£ÁêÜËÆæÁΩÆ...', 'info');
      const data = await makeAuthenticatedRequest('/tokens/tags/set', {
        method: 'POST',
        body: JSON.stringify({
          tokens: [currentEditingToken],
          tags: tags
        })
      });

      if (data && data.status === 'success') {
        showToast('‰ª£ÁêÜËÆæÁΩÆÊàêÂäü', 'success');
        closeModal('proxySelectModal');
        getTokenInfo(); // Âà∑Êñ∞TokenÂàóË°®
      } else {
        showToast('‰ª£ÁêÜËÆæÁΩÆÂ§±Ë¥•', 'error');
      }
    }

    // ÊäΩÂèñÁªüËÆ°‰ª£ÁêÜ‰ΩøÁî®Êï∞ÈáèÁöÑÂÖ¨ÂÖ±ÊñπÊ≥ï
    function getProxyUsageStats() {
      const proxyUsage = {};
      allTokens.forEach(token => {
        const proxy = token.tags?.proxy?.value || '';
        proxyUsage[proxy] = (proxyUsage[proxy] || 0) + 1;
      });
      return proxyUsage;
    }

    // ‰øÆÊ≠£Êó∂Âå∫ÈÄâÊã©Âô®ÂáΩÊï∞
    // ÊâìÂºÄÊó∂Âå∫ÈÄâÊã©Âô®
    function openTimezoneSelector() {
      if (selectedTokens.size === 0) {
        showToast('ËØ∑ÂÖàÈÄâÊã©Token', 'info');
        return;
      }

      // ËÆæÁΩÆÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑtoken
      currentEditingToken = [...selectedTokens][0];
      const tokenObj = allTokens.find(t => t.token === currentEditingToken);
      if (!tokenObj) return;

      // ‰ΩøÁî®ÈÇÆÁÆ±ÊàñËÄÖtokenÁöÑÁÆÄÁü≠ÊòæÁ§∫
      const email = tokenObj.profile?.user?.email || '';
      const displayName = email || tokenObj.token.substring(0, 15) + '...';

      // ÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠ÁöÑTokenÊï∞ÈáèÂíåË¥¶Êà∑‰ø°ÊÅØ
      let displayText = '';
      if (selectedTokens.size === 1) {
        displayText = displayName;
      } else {
        displayText = `Â∑≤ÈÄâÊã© ${selectedTokens.size} ‰∏™Ë¥¶Êà∑/Token`;
      }
      document.getElementById('timezoneTokenDisplay').textContent = displayText;

      // ÂàùÂßãÂåñÊó∂Âå∫ÂàóË°®
      initializeTimezoneList();

      // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑÊó∂Âå∫
      const currentTimezone = tokenObj.tags?.timezone || '';
      highlightSelectedTimezone(currentTimezone);

      // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
      showModal('timezoneModal');

      // ËÆæÁΩÆÊêúÁ¥¢Ê°Ü‰∫ã‰ª∂
      document.getElementById('timezoneSearchInput').addEventListener('input', searchTimezones);
      document.getElementById('timezoneSearchInput').value = '';

      // ÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
      document.getElementById('contextMenu').style.display = 'none';
    }

    // ÂÖ®Â±ÄÊó∂Âå∫ÂàóË°®Êï∞ÁªÑ
    let timezoneList = [];

    // ÂàùÂßãÂåñÊó∂Âå∫ÂàóË°®
    function initializeTimezoneList() {
      try {
        // Â∞ùËØï‰ΩøÁî®Intl.supportedValuesOfËé∑ÂèñÊó∂Âå∫ÂàóË°®ÔºàÁé∞‰ª£ÊµèËßàÂô®ÊîØÊåÅÔºâ
        if (typeof Intl !== 'undefined' && typeof Intl.supportedValuesOf === 'function') {
          timezoneList = Intl.supportedValuesOf('timeZone');
        } else {
          // ÂõûÈÄÄÂà∞È¢ÑÂÆö‰πâÁöÑÂ∏∏Áî®Êó∂Âå∫ÂàóË°®
          timezoneList = [
            'Africa/Abidjan', 'Africa/Accra', 'Africa/Addis_Ababa', 'Africa/Algiers',
            'Africa/Cairo', 'Africa/Casablanca', 'Africa/Johannesburg', 'Africa/Lagos',
            'Africa/Nairobi', 'America/Anchorage', 'America/Argentina/Buenos_Aires',
            'America/Bogota', 'America/Chicago', 'America/Denver', 'America/Los_Angeles',
            'America/Mexico_City', 'America/New_York', 'America/Phoenix', 'America/Sao_Paulo',
            'America/Toronto', 'Asia/Bangkok', 'Asia/Dubai', 'Asia/Hong_Kong',
            'Asia/Jakarta', 'Asia/Karachi', 'Asia/Kolkata', 'Asia/Manila', 'Asia/Seoul',
            'Asia/Shanghai', 'Asia/Singapore', 'Asia/Taipei', 'Asia/Tehran', 'Asia/Tokyo',
            'Australia/Melbourne', 'Australia/Perth', 'Australia/Sydney',
            'Europe/Amsterdam', 'Europe/Athens', 'Europe/Berlin', 'Europe/Brussels',
            'Europe/Istanbul', 'Europe/London', 'Europe/Madrid', 'Europe/Moscow', 'Europe/Paris',
            'Europe/Rome', 'Europe/Stockholm', 'Pacific/Auckland', 'Pacific/Honolulu',
            'UTC'
          ];
        }

        renderTimezoneList(timezoneList);
      } catch (error) {
        console.error('Ëé∑ÂèñÊó∂Âå∫ÂàóË°®Â§±Ë¥•:', error);
        showToast('Ëé∑ÂèñÊó∂Âå∫ÂàóË°®Â§±Ë¥•', 'error');
      }
    }

    // Ê∏≤ÊüìÊó∂Âå∫ÂàóË°®
    function renderTimezoneList(timezones) {
      const container = document.getElementById('timezoneListContainer');

      // Ê∑ªÂä†‰∏Ä‰∏™"Êú™ÊåáÂÆö"ÈÄâÈ°π
      let html = `
        <div class="timezone-item" data-timezone="" onclick="selectTimezone('')">
          <span>Êú™ÊåáÂÆö</span>
        </div>
      `;

      // Ê∑ªÂä†ÂÖ∂‰ªñÊó∂Âå∫ÈÄâÈ°π
      timezones.forEach(timezone => {
        html += `
          <div class="timezone-item" data-timezone="${timezone}" onclick="selectTimezone('${timezone}')">
            <span>${timezone}</span>
          </div>
        `;
      });

      container.innerHTML = html;

      // Ê∑ªÂä†Ê†∑Âºè
      const style = document.createElement('style');
      style.textContent = `
        .timezone-item {
          padding: 8px 16px;
          cursor: pointer;
          transition: all var(--transition-fast);
          border-bottom: 1px solid var(--border-color);
        }
        .timezone-item:last-child {
          border-bottom: none;
        }
        .timezone-item:hover {
          background: var(--primary-color-alpha);
        }
        .timezone-item.selected {
          background: var(--primary-color);
          color: white;
        }
      `;
      document.head.appendChild(style);
    }

    // ÊêúÁ¥¢Êó∂Âå∫
    function searchTimezones() {
      const searchTerm = document.getElementById('timezoneSearchInput').value.toLowerCase();

      // Â¶ÇÊûúÊêúÁ¥¢ËØç‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâÊó∂Âå∫
      if (!searchTerm) {
        renderTimezoneList(timezoneList);
        return;
      }

      // ËøáÊª§ÂåπÈÖçÁöÑÊó∂Âå∫
      const filteredTimezones = timezoneList.filter(timezone =>
        timezone.toLowerCase().includes(searchTerm)
      );

      renderTimezoneList(filteredTimezones);
    }

    // ÈÄâÊã©Êó∂Âå∫
    let selectedTimezone = '';
    function selectTimezone(timezone) {
      selectedTimezone = timezone;
      highlightSelectedTimezone(timezone);
    }

    // È´ò‰∫ÆÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊó∂Âå∫
    function highlightSelectedTimezone(timezone) {
      // ÁßªÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
      const items = document.querySelectorAll('.timezone-item');
      items.forEach(item => item.classList.remove('selected'));

      // Ê∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
      const selectedItem = document.querySelector(`.timezone-item[data-timezone="${timezone}"]`);
      if (selectedItem) {
        selectedItem.classList.add('selected');
      }
    }

    // ‰øùÂ≠òÊó∂Âå∫ÈÄâÊã©
    async function saveTimezoneSelection() {
      if (selectedTokens.size === 0) return;

      closeModal('timezoneModal');

      const tokensToUpdate = [...selectedTokens];
      const tokensData = tokensToUpdate.map(token => {
        // Ëé∑ÂèñÂΩìÂâçtokenÁöÑÊ†áÁ≠æ
        const tokenObj = allTokens.find(t => t.token === token);
        if (!tokenObj) return null;

        // ‰øùÊåÅÂéüÊù•ÁöÑ‰ª£ÁêÜËÆæÁΩÆ
        const proxyName = tokenObj.tags?.proxy || '';
        return {
          token,
          tags: {
            timezone: selectedTimezone || undefined,
            proxy: proxyName || undefined
          }
        };
      }).filter(Boolean); // ËøáÊª§ÊéânullÂÄº

      if (tokensData.length === 0) {
        showToast('Ê≤°ÊúâÂèØÊõ¥Êñ∞ÁöÑToken', 'error');
        return;
      }

      showToast(`Ê≠£Âú®Êõ¥Êñ∞${tokensData.length}‰∏™TokenÁöÑÊó∂Âå∫ËÆæÁΩÆ...`, 'info');

      // ‰ΩøÁî®Promise.allÂπ∂Ë°åÂ§ÑÁêÜÊâÄÊúâÊõ¥Êñ∞ËØ∑Ê±Ç
      const promises = tokensData.map(data =>
        makeAuthenticatedRequest('/tokens/tags/set', {
          method: 'POST',
          body: JSON.stringify({
            tokens: [data.token],
            tags: data.tags
          })
        })
      );

      try {
        await Promise.all(promises);
        showToast('Êó∂Âå∫ËÆæÁΩÆÊàêÂäü', 'success');
        getTokenInfo(); // Âà∑Êñ∞TokenÂàóË°®
      } catch (error) {
        showToast('Êó∂Âå∫ËÆæÁΩÆÂ§±Ë¥•', 'error');
        console.error('ËÆæÁΩÆÊó∂Âå∫Âá∫Èîô:', error);
      }
    }

    // Ê∑ªÂä†Êõ¥Êñ∞Êó∂Âå∫Á≠õÈÄâ‰∏ãÊãâÊ°ÜÂäüËÉΩ
    function updateTimezoneFilter() {
      const timezoneFilterSelect = document.getElementById('timezoneFilter');

      // ‰øùÊåÅÁ¨¨‰∏Ä‰∏™ÂíåÁ¨¨‰∫å‰∏™ÈÄâÈ°πÔºàÂÖ®ÈÉ®Êó∂Âå∫ÂíåÊú™ÊåáÂÆöÊó∂Âå∫Ôºâ
      while (timezoneFilterSelect.options.length > 2) {
        timezoneFilterSelect.remove(2);
      }

      // Ëé∑ÂèñÊâÄÊúâ‰ΩøÁî®ÁöÑÊó∂Âå∫Âπ∂ÁªüËÆ°Êï∞Èáè
      const timezoneUsage = {};
      allTokens.forEach(token => {
        const timezone = token.tags?.timezone || '';
        if (timezone) { // Âè™ÁªüËÆ°ÈùûÁ©∫Êó∂Âå∫
          timezoneUsage[timezone] = (timezoneUsage[timezone] || 0) + 1;
        }
      });

      // Êåâ‰ΩøÁî®ÈáèÊéíÂ∫èÊó∂Âå∫
      const sortedTimezones = Object.keys(timezoneUsage).sort((a, b) =>
        timezoneUsage[b] - timezoneUsage[a]
      );

      // Ê∑ªÂä†Êó∂Âå∫ÈÄâÈ°π
      sortedTimezones.forEach(timezone => {
        const option = document.createElement('option');
        option.value = timezone;
        option.textContent = `${timezone} (${timezoneUsage[timezone]})`;
        timezoneFilterSelect.appendChild(option);
      });
    }

    // ËÆæÁΩÆTokenÁä∂ÊÄÅ
    async function setTokenStatus(status) {
      if (selectedTokens.size === 0) {
        showToast('ËØ∑ÂÖàÈÄâÊã©Token', 'info');
        return;
      }

      const tokensArray = [...selectedTokens];

      showToast('Ê≠£Âú®Êõ¥Êñ∞TokenÁä∂ÊÄÅ...', 'info');

      try {
        const result = await makeAuthenticatedRequest('/tokens/status/set', {
          body: JSON.stringify({
            tokens: tokensArray,
            status: status
          })
        });

        if (result && result.status === 'success') {
          showToast(result.message || 'Áä∂ÊÄÅÊõ¥Êñ∞ÊàêÂäü', 'success');
          getTokenInfo(); // Âà∑Êñ∞TokenÂàóË°®
        } else {
          // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
          const errorMessage = result?.error || result?.message || 'Áä∂ÊÄÅÊõ¥Êñ∞Â§±Ë¥•';
          showToast(errorMessage, 'error');
        }
      } catch (error) {
        // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
        const errorMessage = error.response?.data?.message || error.response?.data?.error || error.message;
        showToast(`Áä∂ÊÄÅÊõ¥Êñ∞Â§±Ë¥•: ${errorMessage}`, 'error');
      }

      // ÂÖ≥Èó≠‰∏ä‰∏ãÊñáËèúÂçï
      document.getElementById('contextMenu').style.display = 'none';
      // Êõ¥Êñ∞Áä∂ÊÄÅÂ≠êËèúÂçï
      updateStatusSubmenu();
    }

    // Êõ¥Êñ∞Áä∂ÊÄÅÂ≠êËèúÂçï
    function updateStatusSubmenu() {
      const submenu = document.getElementById('statusSubmenu');
      if (!submenu) return;

      // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑtokenÂØπË±°
      const selectedTokenObjs = allTokens.filter(t => selectedTokens.has(t.token));
      const selectionSize = selectedTokenObjs.length;

      // ËÆ°ÁÆóÈÄâ‰∏≠È°πÁöÑÁä∂ÊÄÅÁªüËÆ°
      const selectedStatusStats = {
        'enabled': 0,
        'disabled': 0
      };

      selectedTokenObjs.forEach(token => {
        // Â∞Ü undefined Êàñ 'enabled' Áä∂ÊÄÅËßÜ‰∏∫ 'enabled'
        const status = token.status === 'disabled' ? 'disabled' : 'enabled';
        selectedStatusStats[status]++; // Â¢ûÂä†ÂØπÂ∫îÁä∂ÊÄÅÁöÑËÆ°Êï∞
      });

      // Êõ¥Êñ∞ "ÂêØÁî®" ÈÄâÈ°π
      const enabledItem = submenu.querySelector('.context-menu-item[onclick="setTokenStatus(\\"enabled\\")"]');
      if (enabledItem) {
        const enabledCountSpan = enabledItem.querySelector('.status-count');
        if (enabledCountSpan) {
          // ÊòæÁ§∫ÈÄâ‰∏≠È°π‰∏≠ÂêØÁî®ÁöÑÊï∞Èáè
          enabledCountSpan.textContent = selectedStatusStats['enabled'];
        }
        // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÈÄâ‰∏≠ÁöÑ Token ÈÉΩÂ§Ñ‰∫éÂêØÁî®Áä∂ÊÄÅ
        const isEnabledActive = selectionSize > 0 && selectedStatusStats['enabled'] === selectionSize;
        enabledItem.classList.toggle('active', isEnabledActive); // ËÆæÁΩÆÈÄâ‰∏≠Ê†áËÆ∞
      }

      // Êõ¥Êñ∞ "Á¶ÅÁî®" ÈÄâÈ°π
      const disabledItem = submenu.querySelector('.context-menu-item[onclick="setTokenStatus(\\"disabled\\")"]');
      if (disabledItem) {
        const disabledCountSpan = disabledItem.querySelector('.status-count');
        if (disabledCountSpan) {
          // ÊòæÁ§∫ÈÄâ‰∏≠È°π‰∏≠Á¶ÅÁî®ÁöÑÊï∞Èáè
          disabledCountSpan.textContent = selectedStatusStats['disabled'];
        }
        // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÈÄâ‰∏≠ÁöÑ Token ÈÉΩÂ§Ñ‰∫éÁ¶ÅÁî®Áä∂ÊÄÅ
        const isDisabledActive = selectionSize > 0 && selectedStatusStats['disabled'] === selectionSize;
        disabledItem.classList.toggle('active', isDisabledActive); // ËÆæÁΩÆÈÄâ‰∏≠Ê†áËÆ∞
      }

      // Ê∑ªÂä† has-submenu Á±ª‰ª•‰æøÊòæÁ§∫ÁÆ≠Â§¥
      const statusMenuEl = document.querySelector('.status-menu');
      if (statusMenuEl) {
        statusMenuEl.classList.add('has-submenu');
      }
    }

    // ÂçáÁ∫ßÈÄâ‰∏≠ÁöÑToken
    async function upgradeSelectedTokens() {
      if (selectedTokens.size === 0) {
        showToast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂçáÁ∫ßÁöÑToken', 'info');
        return;
      }

      const tokensToUpgrade = [...selectedTokens];
      showToast(`Ê≠£Âú®ÂçáÁ∫ß ${tokensToUpgrade.length} ‰∏™Token...`, 'info');

      // ÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
      document.getElementById('contextMenu').style.display = 'none';

      try {
        const data = await makeAuthenticatedRequest('/tokens/upgrade', {
          body: JSON.stringify(tokensToUpgrade)
        });

        if (data && data.status === 'success') {
          showToast(data.message || 'ÂçáÁ∫ßÊàêÂäü', 'success');
          getTokenInfo();
        } else {
          showToast('ÂçáÁ∫ßÂ§±Ë¥•: ' + (data.message || data.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        const errorMessage = error.response?.data?.message || error.response?.data?.error || error.message;
        showToast(`ÂçáÁ∫ßÂ§±Ë¥•: ${errorMessage}`, 'error');
      }
    }
  </script>
</body>

</html>